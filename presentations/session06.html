<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Python Web Programming</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Python Web Programming</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Python Web Programming</h1>

<img alt="img/flask_cover.png" class="align-left" src="img/flask_cover.png" style="width: 50%;" />
<p>Session 6: A Flask Application</p>
<div class="intro-blurb right line-block">
<div class="line">&quot;Web Development,</div>
<div class="line">one drop at a time&quot;</div>
</div>
<p class="image-credit">image: Flask Logo (<a class="reference external" href="http://flask.pocoo.org/community/logos/">http://flask.pocoo.org/community/logos/</a>)</p>

</div>
<div class="slide" id="a-quick-reminder">
<h1>A Quick Reminder</h1>
<p>In our last session we set up a virtualenv in which we have installed the
microframework Flask</p>
<p class="incremental">We spent a few minutes exploring how Flask works, and how it is similar to the
wsgi app we wrote ourselves.</p>
<p class="incremental">We then took a detour to introduce <tt class="docutils literal">Jinja2</tt>, the templating language Flask
uses out of the box.</p>
<p class="incremental">Finally, we learned about the Python DB API 2 by seeing how we can set up a
sqlite3 database and work with it safely.</p>
</div>
<div class="slide" id="moving-on">
<h1>Moving On</h1>
<p>Now it is time to put all that together.</p>
<p class="incremental">We'll spend this session building a &quot;microblog&quot; application.</p>
<p class="incremental">Let's dive right in.</p>
<p class="incremental">Start by activating your Flask virtualenv</p>
</div>
<div class="slide" id="our-database">
<h1>Our Database</h1>
<p>We need first to define what an <em>entry</em> for our microblog might look like.</p>
<p class="incremental">Let's keep it a simple as possible for now.</p>
<p class="incremental">Create a new directory <tt class="docutils literal">microblog</tt>, and open a new file in it:
<tt class="docutils literal">schema.sql</tt></p>
<pre class="code sql incremental small literal-block">
<span class="k">drop</span> <span class="k">table</span> <span class="n">if</span> <span class="k">exists</span> <span class="n">entries</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">entries</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">integer</span> <span class="k">primary</span> <span class="k">key</span> <span class="n">autoincrement</span><span class="p">,</span>
    <span class="n">title</span> <span class="n">string</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="nb">text</span> <span class="n">string</span> <span class="k">not</span> <span class="k">null</span>
<span class="p">);</span>
</pre>
</div>
<div class="slide" id="app-configuration">
<h1>App Configuration</h1>
<p>For any but the most trivial applications, you'll need some configuration.</p>
<p class="incremental">Flask provides a number of ways of loading configuration.  We'll be using a
config file</p>
<p class="incremental">Create a new file <tt class="docutils literal">microblog.cfg</tt> in the same directory.</p>
<pre class="code python small incremental literal-block">
<span class="c"># application configuration for a Flask microblog</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="s">'microblog.db'</span>
</pre>
</div>
<div class="slide" id="our-app-skeleton">
<h1>Our App Skeleton</h1>
<p>Finally, we'll need a basic app skeleton to work from.</p>
<p class="incremental">Create one more file <tt class="docutils literal">microblog.py</tt> in the same directory, and enter the
following:</p>
<pre class="code python small incremental literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_pyfile</span><span class="p">(</span><span class="s">'microblog.cfg'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="test-your-work">
<h1>Test Your Work</h1>
<p>This is enough to get us off the ground.</p>
<div class="incremental container">
<p>From a terminal in the <tt class="docutils literal">microblog</tt> directory, run the app:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
</pre>
</div>
<p class="incremental">Then point your browser at <a class="reference external" href="http://localhost:5000/">http://localhost:5000/</a></p>
<p class="incremental">What do you see in your browser?  In the terminal?  Why?</p>
</div>
<div class="slide" id="creating-the-database">
<h1>Creating the Database</h1>
<p>Quit the app with <tt class="docutils literal">^C</tt>. Then return to <tt class="docutils literal">microblog.py</tt> and add the
following:</p>
<pre class="code python incremental small literal-block">
<span class="c"># add this up at the top</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="c"># add the rest of this below the app.config statement</span>
<span class="k">def</span> <span class="nf">connect_db</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">])</span>
</pre>
<p class="incremental">This should look familiar. What will happen?</p>
<p class="incremental">This convenience method allows us to write our very first test.</p>
</div>
<div class="slide" id="tests-and-tdd">
<h1>Tests and TDD</h1>
<p class="center"><strong>If it isn't tested, it's broken</strong></p>
<p class="incremental">Test-Driven Development means writing the tests before writing the code.
As your tests pass, you know you're building what you want.</p>
<p class="incremental">We are going to write tests at every step of this exercise using the
<tt class="docutils literal">unittest</tt> module.</p>
<p class="incremental">You'll want to read more about this module. See the reading list for
suggestions.</p>
</div>
<div class="slide" id="testing-environment">
<h1>Testing Environment</h1>
<p>The Python <tt class="docutils literal">unittest</tt> module defines a class called a <tt class="docutils literal">TestCase</tt>. It
serves as a container for a set of tests and the code needed to run them.</p>
<p class="incremental">This class provides <tt class="docutils literal">setUp</tt> and <tt class="docutils literal">tearDown</tt> methods to control the
environment for each test.</p>
<p class="incremental">These methods are run before and after <em>each test</em>, and may be used to provide
<em>isolation</em> between tests.</p>
<p class="incremental">In your <tt class="docutils literal">microblog</tt> folder create a <tt class="docutils literal">microblog_tests.py</tt> file.</p>
<p class="incremental">Open it in your editor.</p>
</div>
<div class="slide" id="testing-setup">
<h1>Testing Setup</h1>
<p>Add the following to provide minimal test setup.</p>
<pre class="code python small literal-block">
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">unittest</span>

<span class="kn">import</span> <span class="nn">microblog</span>

<span class="k">class</span> <span class="nc">MicroblogTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">db_fd</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_fd</span><span class="p">,</span> <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">]</span> <span class="o">=</span> <span class="n">db_fd</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'TESTING'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">app</span>
</pre>
</div>
<div class="slide" id="testing-teardown">
<h1>Testing Teardown</h1>
<p>Add this method to your test case class to tear down after each test:</p>
<pre class="code python literal-block">
<span class="k">class</span> <span class="nc">MicroblogTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="c"># ...</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_fd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'DATABASE'</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="make-tests-runnable">
<h1>Make Tests Runnable</h1>
<p>To make the test module runnable, we need a <tt class="docutils literal">__main__</tt> block.</p>
<p class="incremental">Calling the <tt class="docutils literal">unittest.main()</tt> function here will find test cases and run
their tests.</p>
<div class="incremental container">
<p>Add the following at the end of <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre>
</div>
<p class="incremental">Now, we're ready to add our first actual test..</p>
</div>
<div class="slide" id="test-databse-setup">
<h1>Test Databse Setup</h1>
<p>We'd like to test that our database is correctly initialized. The schema has
one table with three columns. Let's test that.</p>
<div class="incremental container">
<p>Add the following method to your test class in <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_database_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">connect_db</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'PRAGMA table_info(entries);'</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="run-the-tests">
<h1>Run the Tests</h1>
<p>We can now run our test module:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
F
======================================================================
FAIL: test_database_setup (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 23, in test_database_setup
    self.assertEquals(len(rows) == 3)
AssertionError: 0 != 3

----------------------------------------------------------------------
Ran 1 test in 0.011s

FAILED (failures=1)
</pre>
</div>
<div class="slide" id="make-the-test-pass">
<h1>Make the Test Pass</h1>
<p>This is an expected failure. Why?</p>
<div class="incremental container">
<p>Let's add some code to <tt class="docutils literal">microblog.py</tt> that will actually create our
database schema:</p>
<pre class="code python small literal-block">
<span class="c"># add this import at the top</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>

<span class="c"># add this function after the connect_db function</span>
<span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">connect_db</span><span class="p">())</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">open_resource</span><span class="p">(</span><span class="s">'schema.sql'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span><span class="o">.</span><span class="n">executescript</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
</div>
</div>
<div class="slide" id="initialize-the-db-in-tests">
<h1>Initialize the DB in Tests</h1>
<p>We also need to call that function in our <tt class="docutils literal">microblog_tests.py</tt> to set up the
database schema for each test.</p>
<div class="incremental container">
<p>Add the following line at the end of that <tt class="docutils literal">setUp</tt> method:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="n">microblog</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span> <span class="c"># &lt;- add this at the end</span>
</pre>
</div>
<pre class="incremental literal-block">
(flaskenv)$ python microblog_tests.py
</pre>
</div>
<div class="slide" id="success">
<h1>Success?</h1>
<p class="big-centered incremental">\o/ Wahoooo!</p>
</div>
<div class="slide" id="initialize-the-db-irl">
<h1>Initialize the DB IRL</h1>
<p>Our test passed, so we have confidence that <tt class="docutils literal">init_db</tt> does what it should</p>
<p class="incremental">We'll need to have a working database for our app, so let's go ahead and do
this &quot;in real life&quot;</p>
<p class="incremental">(flaskenv)$ python</p>
<pre class="code python incremental literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">microblog</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">microblog</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="o">^</span><span class="n">D</span>
</pre>
</div>
<div class="slide" id="reading-and-writing-data">
<h1>Reading and Writing Data</h1>
<p>After you quit the interpreter, you should see <tt class="docutils literal">microblog.db</tt> in your
directory.</p>
<p class="incremental">It's time now to think about writing and reading data for our blog.</p>
<p class="incremental">We'll start by writing tests.</p>
<p class="incremental">But first, a word or two about the circle of life.</p>
</div>
<div class="slide" id="the-request-response-cycle">
<h1>The Request/Response Cycle</h1>
<p>Every interaction in HTTP is bounded by the interchange of one request and one
response.</p>
<p class="incremental">No HTTP application can do anything until some client makes a request.</p>
<p class="incremental">And no action by an application is complete until a response has been sent
back to the client.</p>
<p class="incremental">This is the lifecycle of an http web application.</p>
</div>
<div class="slide" id="managing-db-connections">
<h1>Managing DB Connections</h1>
<p>It makes sense to bind the lifecycle of a database connection to this same
border.</p>
<p class="incremental">Flask does not dictate that we write an application that uses a database.</p>
<p class="incremental">Because of this, managing the lifecycle of database connection so that they
are connected to the request/response cycle is up to us.</p>
<p class="incremental">Happily, Flask <em>does</em> have a way to help us.</p>
</div>
<div class="slide" id="request-boundary-decorators">
<h1>Request Boundary Decorators</h1>
<p>The Flask <em>app</em> provides decorators we can use on our database lifecycle
functions:</p>
<ul class="incremental simple">
<li><tt class="docutils literal">&#64;app.before_request</tt>: any method decorated by this will be called before
the cycle begins</li>
<li><tt class="docutils literal">&#64;app.after_request</tt>: any method decorated by this will be called after
the cycle is complete. If an unhandled exception occurs, these functions are
skipped.</li>
<li><tt class="docutils literal">&#64;app.teardown_request</tt>: any method decorated by this will be called at
the end of the cycle, <em>even if</em> an unhandled exception occurs.</li>
</ul>
</div>
<div class="slide" id="managing-our-db">
<h1>Managing our DB</h1>
<p>Think about the following functions:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">get_database_connection</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">&#64;app.teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p class="incremental">How does the <tt class="docutils literal">db</tt> object get from one place to the other?</p>
</div>
<div class="slide" id="global-context-in-flask">
<h1>Global Context in Flask</h1>
<p>Our flask <tt class="docutils literal">app</tt> is only really instantiated once</p>
<p class="incremental">This means that anything we tie to it will be shared across all requests.</p>
<p class="incremental">This is what we call <tt class="docutils literal">global</tt> context.</p>
<p class="incremental">What happens if two clients make a request at the same time?</p>
</div>
<div class="slide" id="local-context-in-flask">
<h1>Local Context in Flask</h1>
<p>Flask provides something it calls a <tt class="docutils literal">local global</tt>: &quot;g&quot;.</p>
<p class="incremental">This is an object that <em>looks</em> global (you can import it anywhere)</p>
<p class="incremental">But in reality, it is <em>local</em> to a single request.</p>
<p class="incremental">Resources tied to this object are <em>not</em> shared among requests. Perfect for
things like a database connection.</p>
</div>
<div class="slide" id="working-db-functions">
<h1>Working DB Functions</h1>
<p>Add the following, working methods to <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># add this import at the top:</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">g</span>

<span class="c"># add these function after init_db</span>
<span class="k">def</span> <span class="nf">get_database_connection</span><span class="p">():</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'db'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">db</span>

<span class="nd">&#64;app.teardown_request</span>
<span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s">'db'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
<div class="slide" id="writing-blog-entries">
<h1>Writing Blog Entries</h1>
<p>Our microblog will have <em>entries</em>. We've set up a simple database schema to
represent them.</p>
<p class="incremental">To write an entry, what would we need to do?</p>
<ul class="incremental simple">
<li>Provide a title</li>
<li>Provide some body text</li>
<li>Write them to a row in the database</li>
</ul>
<p class="incremental">Let's write a test of a function that would do that.</p>
</div>
<div class="slide" id="test-writing-entries">
<h1>Test Writing Entries</h1>
<p>The database connection is bound by a request. We'll need to mock one (in
<tt class="docutils literal">microblog_tests.py</tt>)</p>
<div class="incremental container">
<p>Flask provides <tt class="docutils literal">app.test_request_context</tt> to do just that</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_write_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">con</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">connect_db</span><span class="p">()</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;select * from entries;&quot;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">val</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre>
</div>
</div>
<div class="slide" id="run-your-test">
<h1>Run Your Test</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.E
======================================================================
ERROR: test_write_entry (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 30, in test_write_entry
    microblog.write_entry(*expected)
AttributeError: 'module' object has no attribute 'write_entry'

----------------------------------------------------------------------
Ran 2 tests in 0.018s

FAILED (errors=1)
</pre>
<p class="incremental">Great.  Two tests, one passing.</p>
</div>
<div class="slide" id="make-it-pass">
<h1>Make It Pass</h1>
<p>Now we are ready to write an entry to our database. Add this function to
<tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">write_entry</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">get_database_connection</span><span class="p">()</span>
    <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'insert into entries (title, text) values (?, ?)'</span><span class="p">,</span>
                 <span class="p">[</span><span class="n">title</span><span class="p">,</span> <span class="n">text</span><span class="p">])</span>
    <span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</pre>
<pre class="incremental small literal-block">
(flaskenv)$ python microblog_tests.py
..
----------------------------------------------------------------------
Ran 2 tests in 0.146s

OK
</pre>
</div>
<div class="slide" id="reading-entries">
<h1>Reading Entries</h1>
<p>We'd also like to be able to read the entries in our blog</p>
<div class="incremental container">
<p>We need a method that returns all of them for a listing page</p>
<ul class="incremental simple">
<li>The return value should be a list of entries</li>
<li>If there are none, it should return an empty list</li>
<li>Each entry in the list should be a dictionary of 'title' and 'text'</li>
</ul>
</div>
<p class="incremental">Let's begin by writing tests.</p>
</div>
<div class="slide" id="test-reading-entries">
<h1>Test Reading Entries</h1>
<p>In <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_get_all_entries_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">get_all_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_get_all_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">microblog</span><span class="o">.</span><span class="n">get_all_entries</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'title'</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">expected</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s">'text'</span><span class="p">])</span>
</pre>
</div>
<div class="slide" id="run-your-tests">
<h1>Run Your Tests</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.EE.
======================================================================
ERROR: test_get_all_entries (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 47, in test_get_all_entries
    entries = microblog.get_all_entries()
AttributeError: 'module' object has no attribute 'get_all_entries'

======================================================================
ERROR: test_get_all_entries_empty (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 40, in test_get_all_entries_empty
    entries = microblog.get_all_entries()
AttributeError: 'module' object has no attribute 'get_all_entries'

----------------------------------------------------------------------
Ran 4 tests in 0.021s

FAILED (errors=2)
</pre>
</div>
<div class="slide" id="make-them-pass">
<h1>Make Them Pass</h1>
<p>Now we have 4 tests, and two fail.</p>
<p class="incremental">add the <tt class="docutils literal">get_all_entries</tt> function to <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">get_all_entries</span><span class="p">():</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">get_database_connection</span><span class="p">()</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">'SELECT title, text FROM entries ORDER BY id DESC'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">text</span><span class="o">=</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</pre>
<div class="incremental container">
<p>And back in your terminal:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
....
----------------------------------------------------------------------
Ran 4 tests in 0.021s

OK
</pre>
</div>
</div>
<div class="slide" id="where-we-stand">
<h1>Where We Stand</h1>
<p>We've moved quite a ways in implementing our microblog:</p>
<ul class="incremental simple">
<li>We've created code to initialize our database schema</li>
<li>We've added functions to manage the lifecycle of our database connection</li>
<li>We've put in place functions to write and read blog entries</li>
<li>And, since it's tested, we are reasonably sure our code does what we think
it does.</li>
</ul>
<p class="incremental">We're ready now to put a face on it, so we can see what we're doing!</p>
</div>
<div class="slide" id="break-time">
<h1>Break Time</h1>
<p>But first, let's take a quick break to clear our heads.</p>
</div>
<div class="slide" id="templates-in-flask">
<h1>Templates In Flask</h1>
<p>We'll start with a detour into templates as they work in Flask</p>
<div class="incremental container">
<p>Jinja2 templates use the concept of an <em>Environment</em> to:</p>
<ul class="incremental simple">
<li>Figure out where to look for templates</li>
<li>Set configuration for the templating system</li>
<li>Add some commonly used functionality to the template <em>context</em></li>
</ul>
</div>
<p class="incremental">Flask sets up a proper Jinja2 Environment when you instantiate your <tt class="docutils literal">app</tt>.</p>
</div>
<div class="slide" id="flask-environment">
<h1>Flask Environment</h1>
<p>Flask uses the value you pass to the <tt class="docutils literal">app</tt> constructor to calculate the root
of your application on the filesystem.</p>
<p class="incremental">From that root, it expects to find templates in a directory name <tt class="docutils literal">templates</tt></p>
<div class="incremental container">
<p>This allows you to use the <tt class="docutils literal">render_template</tt> command from <tt class="docutils literal">flask</tt> like
so:</p>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>
<span class="n">page_html</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'hello_world.html'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Cris&quot;</span><span class="p">)</span>
</pre>
</div>
</div>
<div class="slide" id="flask-context">
<h1>Flask Context</h1>
<p>Keyword arguments you pass to <tt class="docutils literal">render_template</tt> become the <em>context</em> passed
to the template for rendering.</p>
<p class="incremental">Flask will add a few things to this context.</p>
<ul class="incremental simple">
<li><strong>config</strong>: contains the current configuration object</li>
<li><strong>request</strong>: contains the current request object</li>
<li><strong>session</strong>: any session data that might be available</li>
<li><strong>g</strong>: the request-local object to which global variables are bound</li>
<li><strong>url_for</strong>: so you can easily <em>reverse</em> urls from within your templates</li>
<li><strong>get_flashed_messages</strong>: a function that returns messages you flash to your
users (more on this later).</li>
</ul>
</div>
<div class="slide" id="setting-up-our-templates">
<h1>Setting Up Our Templates</h1>
<p>In your <tt class="docutils literal">microblog</tt> directory, add a new <tt class="docutils literal">templates</tt> directory</p>
<div class="incremental container">
<p>In this directory create a new file <tt class="docutils literal">layout.html</tt></p>
<pre class="code jinja small literal-block">
<span class="x">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;Microblog!&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;My Microblog&lt;/h1&gt;
    &lt;div class=&quot;content&quot;&gt;
    </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="x">
    &lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;</span>
</pre>
</div>
</div>
<div class="slide" id="template-inheritance">
<h1>Template Inheritance</h1>
<p>You can combine templates in a number of different ways.</p>
<ul class="incremental simple">
<li>you can make replaceable blocks in templates with blocks<ul>
<li><tt class="docutils literal">{% block foo <span class="pre">%}{%</span> endblock %}</tt></li>
</ul>
</li>
<li>you can build on a template in a second template by extending<ul>
<li><tt class="docutils literal">{% extends &quot;layout.html&quot; %}</tt></li>
<li>this <em>must</em> be the first text in the template</li>
</ul>
</li>
<li>you can re-use common structure with <em>include</em>:<ul>
<li><tt class="docutils literal">{% include &quot;footer.html&quot; %}</tt></li>
</ul>
</li>
</ul>
</div>
<div class="slide" id="id1">
<h1>Template Inheritance</h1>
<p>You can even build libraries of template <em>macros</em> and import them:</p>
<pre class="code jinja small incremental literal-block">
<span class="cp">{%</span> <span class="k">macro</span> <span class="nv">input</span><span class="o">(</span><span class="nv">label</span><span class="o">,</span> <span class="nv">name</span><span class="o">=</span><span class="s1">'input'</span><span class="o">,</span> <span class="nv">value</span><span class="o">=</span><span class="s1">''</span><span class="o">,</span> <span class="nv">type</span><span class="o">=</span><span class="s1">'text'</span><span class="o">)</span> -<span class="cp">%}</span><span class="x">
    &lt;label&gt;</span><span class="cp">{{</span> <span class="nv">label</span> <span class="cp">}}</span><span class="x">
    &lt;input type=&quot;</span><span class="cp">{{</span> <span class="nv">type</span> <span class="cp">}}</span><span class="x">&quot; value=&quot;</span><span class="cp">{{</span> <span class="nv">value</span><span class="o">|</span><span class="nf">e</span> <span class="cp">}}</span><span class="x">&quot; name=&quot;</span><span class="cp">{{</span> <span class="nv">name</span> <span class="cp">}}</span><span class="x">&quot;/&gt;
    &lt;/label&gt;
</span><span class="cp">{%</span>- <span class="k">endmacro</span> <span class="cp">%}</span>
</pre>
<pre class="code jinja small incremental literal-block">
<span class="cp">{%</span> <span class="k">import</span> <span class="s2">&quot;forms.html&quot;</span> <span class="k">as</span> <span class="nv">forms</span> <span class="cp">%}</span><span class="x">
&lt;form id=&quot;user_login&quot; action=&quot;&quot; method=&quot;POST&quot;&gt;
    </span><span class="cp">{{</span> <span class="nv">forms.input</span><span class="o">(</span><span class="s2">&quot;Username&quot;</span><span class="o">,</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;username&quot;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">
    </span><span class="cp">{{</span> <span class="nv">forms.input</span><span class="o">(</span><span class="s2">&quot;Password&quot;</span><span class="o">,</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">
    </span><span class="cp">{{</span> <span class="nv">forms.input</span><span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="nv">value</span><span class="o">=</span><span class="s2">&quot;Log in&quot;</span><span class="o">)</span> <span class="cp">}}</span><span class="x">
&lt;/form&gt;</span>
</pre>
</div>
<div class="slide" id="displaying-an-entries-list">
<h1>Displaying an Entries List</h1>
<p>Create a new file, <tt class="docutils literal">show_entries.html</tt> in <tt class="docutils literal">templates</tt>:</p>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;layout.html&quot;</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">
  &lt;h2&gt;Posts&lt;/h2&gt;
  &lt;ul class=&quot;entries&quot;&gt;
  </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">entry</span> <span class="k">in</span> <span class="nv">entries</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;
      &lt;h2&gt;</span><span class="cp">{{</span> <span class="nv">entry.title</span> <span class="cp">}}</span><span class="x">&lt;/h2&gt;
      &lt;div class=&quot;entry_body&quot;&gt;
      </span><span class="cp">{{</span> <span class="nv">entry.text</span><span class="o">|</span><span class="nf">safe</span> <span class="cp">}}</span><span class="x">
      &lt;/div&gt;
    &lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
    &lt;li&gt;&lt;em&gt;No entries here so far&lt;/em&gt;&lt;/li&gt;
  </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
  &lt;/ul&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="viewing-entries">
<h1>Viewing Entries</h1>
<p>We just need a Python function that will:</p>
<ul class="incremental simple">
<li>build a list of entries</li>
<li>pass the list to our template to be rendered</li>
<li>return the result to a client's browser</li>
</ul>
<p class="incremental">As usual, we'll start by writing tests for this new function</p>
</div>
<div class="slide" id="test-viewing-entries">
<h1>Test Viewing Entries</h1>
<p>Add the following two tests to <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_empty_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'No entries here so far'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>

<span class="k">def</span> <span class="nf">test_listing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;My Title&quot;</span><span class="p">,</span> <span class="s">&quot;My Text&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">write_entry</span><span class="p">(</span><span class="o">*</span><span class="n">expected</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
</pre>
<p class="incremental"><tt class="docutils literal">app.test_client()</tt> creates a mock http client for us.</p>
</div>
<div class="slide" id="id2">
<h1>Run Your Tests</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.F..F.
======================================================================
FAIL: test_empty_listing (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 55, in test_empty_listing
    assert 'No entries here so far' in response.data
AssertionError
======================================================================
FAIL: test_listing (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 63, in test_listing
    assert value in response.data
AssertionError
----------------------------------------------------------------------
Ran 6 tests in 0.138s

FAILED (failures=2)
</pre>
</div>
<div class="slide" id="id3">
<h1>Make Them Pass</h1>
<p>In <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># at the top, import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">render_template</span>

<span class="c"># and after our last functions:</span>
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">show_entries</span><span class="p">():</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="n">get_all_entries</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'show_entries.html'</span><span class="p">,</span> <span class="n">entries</span><span class="o">=</span><span class="n">entries</span><span class="p">)</span>
</pre>
<pre class="incremental small literal-block">
(flaskenv)$ python microblog_tests.py
......
----------------------------------------------------------------------
Ran 6 tests in 0.100s

OK
</pre>
</div>
<div class="slide" id="authentication">
<h1>Authentication</h1>
<p>We don't want just anyone to be able to add new entries. So we want to be able
to authenticate a user.</p>
<p class="incremental">Flask provides <em>session</em> concept as a way to store and access data for a given
client.</p>
<p class="incremental">The session in Flask uses encrypted HTTP <em>Cookies</em></p>
<p class="incremental">We will require a few changes to our app configuration to use this session.</p>
</div>
<div class="slide" id="additional-config">
<h1>Additional Config</h1>
<p>In <tt class="docutils literal">microblog.cfg</tt> add the following lines:</p>
<pre class="code python small literal-block">
<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">&quot;sooperseekritvaluenooneshouldknow&quot;</span>
<span class="n">USERNAME</span> <span class="o">=</span> <span class="s">&quot;admin&quot;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s">&quot;secret&quot;</span>
</pre>
<p class="incremental"><tt class="docutils literal">SECRET_KEY</tt> is a value that will be used to encrypt the session cookie. If
it isn't set, sessions won't be created.</p>
<p class="incremental"><tt class="docutils literal">USERNAME</tt> and <tt class="docutils literal">PASSWORD</tt> are our admin credentials.</p>
<p class="small center incremental">obviously this is not a robust login system, do not do this in real life</p>
</div>
<div class="slide" id="test-authentication">
<h1>Test Authentication</h1>
<p>Back in <tt class="docutils literal">microblog_tests.py</tt> add new test methods:</p>
<pre class="code python small literal-block">
<span class="c"># up with the imports</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">session</span>

<span class="c"># at the end of our list of test methods</span>
<span class="k">def</span> <span class="nf">test_login_passes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="n">microblog</span><span class="o">.</span><span class="n">do_login</span><span class="p">(</span><span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'USERNAME'</span><span class="p">],</span>
                           <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'PASSWORD'</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'logged_in'</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_login_fails</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_request_context</span><span class="p">(</span><span class="s">'/'</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span>
                          <span class="n">microblog</span><span class="o">.</span><span class="n">do_login</span><span class="p">,</span>
                          <span class="n">microblog</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'USERNAME'</span><span class="p">],</span>
                          <span class="s">'incorrectpassword'</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id4">
<h1>Run Your Tests</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.....EE.
======================================================================
ERROR: test_login_fails (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 76, in test_login_fails
    microblog.do_login,
AttributeError: 'module' object has no attribute 'do_login'
======================================================================
ERROR: test_login_passes (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 69, in test_login_passes
    microblog.do_login(microblog.app.config['USERNAME'],
AttributeError: 'module' object has no attribute 'do_login'
----------------------------------------------------------------------
Ran 8 tests in 0.082s

FAILED (errors=2)
</pre>
</div>
<div class="slide" id="id5">
<h1>Make Them Pass</h1>
<p>In <tt class="docutils literal">microblog.py</tt>:</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">session</span>

<span class="c"># and a function</span>
<span class="k">def</span> <span class="nf">do_login</span><span class="p">(</span><span class="n">usr</span><span class="p">,</span> <span class="n">pwd</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">usr</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'USERNAME'</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">elif</span> <span class="n">pwd</span> <span class="o">!=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">'PASSWORD'</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">session</span><span class="p">[</span><span class="s">'logged_in'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
</pre>
<p class="incremental">Re-run your tests, you should now be 8 for 8</p>
</div>
<div class="slide" id="creating-login-logout">
<h1>Creating Login/Logout</h1>
<p>We need to have the ability to log in and out of our application.</p>
<div class="incremental container">
<p>This means we need views that will</p>
<ul class="incremental simple">
<li>Allow a user to provide credentials and attempt to login</li>
<li>Redirect to the listing page if they succeed</li>
<li>Give appropriate feedback if they fail</li>
<li>Allow a user to log out if they are logged in</li>
<li>Redirect to the listing page after logging out</li>
</ul>
</div>
<p class="incremental">Let's begin as usual by writing some tests</p>
</div>
<div class="slide" id="helper-methods-in-tests">
<h1>Helper Methods in Tests</h1>
<p>We will need to log in or out a few times in our test.</p>
<div class="incremental container">
<p>Add helper methods to our <tt class="docutils literal">microblog_tests.py</tt> TestCase:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">password</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'/logout'</span><span class="p">,</span>
                           <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre>
</div>
<p class="incremental small"><strong>Note:</strong> Methods that do not begin with <tt class="docutils literal">test</tt> will not be run as tests.</p>
</div>
<div class="slide" id="testing-login-logout">
<h1>Testing Login/Logout</h1>
<p>And now the test itself:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_login_logout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># verify we can log in</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'admin'</span><span class="p">,</span> <span class="s">'secret'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'You were logged in'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
    <span class="c"># verify we can log back out</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s">'You were logged out'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
    <span class="c"># verify that incorrect credentials get a proper message</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'notadmin'</span><span class="p">,</span> <span class="s">'secret'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'Invalid Login'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'admin'</span><span class="p">,</span> <span class="s">'notsosecret'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'Invalid Login'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
</pre>
</div>
<div class="slide" id="id6">
<h1>Run Your Tests</h1>
<p>You should now have nine tests, with one failure:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
......F..
======================================================================
FAIL: test_login_logout (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 93, in test_login_logout
    assert 'You were logged in' in response.data
AssertionError

----------------------------------------------------------------------
Ran 9 tests in 0.047s

FAILED (failures=1)
</pre>
</div>
<div class="slide" id="login-form-template">
<h1>Login Form Template</h1>
<p>Add <tt class="docutils literal">login.html</tt> to the <tt class="docutils literal">templates</tt> directory:</p>
<pre class="code jinja tiny literal-block">
<span class="cp">{%</span> <span class="k">extends</span> <span class="s2">&quot;layout.html&quot;</span> <span class="cp">%}</span><span class="x">
</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">
  &lt;h2&gt;Login&lt;/h2&gt;
  </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">error</span> -<span class="cp">%}</span><span class="x">
    &lt;p class=&quot;error&quot;&gt;&lt;strong&gt;Error&lt;/strong&gt; </span><span class="cp">{{</span> <span class="nv">error</span> <span class="cp">}}</span><span class="x">
  </span><span class="cp">{%</span>- <span class="k">endif</span> <span class="cp">%}</span><span class="x">
  &lt;form action=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'login'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; method=&quot;POST&quot;&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;
      &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot;/&gt;
    &lt;/div&gt;
    &lt;div class=&quot;field&quot;&gt;
      &lt;label for=&quot;password&quot;&gt;Password&lt;/label&gt;
      &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot;/&gt;
    &lt;/div&gt;
    &lt;div class=&quot;control_row&quot;&gt;
      &lt;input type=&quot;submit&quot; name=&quot;Login&quot; value=&quot;Login&quot;/&gt;
    &lt;/div&gt;
  &lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre>
</div>
<div class="slide" id="required-imports">
<h1>Required Imports</h1>
<p>Back in <tt class="docutils literal">microblog.py</tt>, we need to import some symbols from flask:</p>
<pre class="code python literal-block">
<span class="c"># at the top, new imports</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">flash</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span>
</pre>
<p class="incremental">And finally, we'll add the view functions we need to fix our tests</p>
</div>
<div class="slide" id="id7">
<h1>Make the Test Pass</h1>
<pre class="code python small literal-block">
<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/login'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">,</span> <span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="n">error</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">'POST'</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">do_login</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'username'</span><span class="p">],</span>
                     <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'password'</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s">&quot;Invalid Login&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flash</span><span class="p">(</span><span class="s">'You were logged in'</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">'login.html'</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/logout'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'logged_in'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">flash</span><span class="p">(</span><span class="s">'You were logged out'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="about-flash">
<h1>About Flash</h1>
<p class="small"><tt class="docutils literal">flash</tt> allows sending messages to clients. We need a place to show these
messages. Add it to <tt class="docutils literal">layout.html</tt> (along with links to log in and out)</p>
<pre class="code jinja small literal-block">
<span class="x">&lt;h1&gt;My Microblog&lt;/h1&gt;       &lt;!-- already there --&gt;
&lt;div class=&quot;metanav&quot;&gt; &lt;!-- add all this --&gt;
</span><span class="cp">{%</span> <span class="k">if</span> <span class="k">not</span> <span class="nv">session.logged_in</span> <span class="cp">%}</span><span class="x">
  &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'login'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;log in&lt;/a&gt;
</span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span><span class="x">
  &lt;a href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'logout'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot;&gt;log_out&lt;/a&gt;
</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
&lt;/div&gt;
</span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">get_flashed_messages</span><span class="o">()</span> <span class="cp">%}</span><span class="x">
&lt;div class=&quot;flash&quot;&gt;</span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span><span class="x">&lt;/div&gt;
</span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span><span class="x">
&lt;div class=&quot;content&quot;&gt; &lt;!-- already there --&gt;</span>
</pre>
</div>
<div class="slide" id="nine-for-nine">
<h1>Nine For Nine</h1>
<p>At this point, we are displaying the messages we sent from the view code, so
our tests should pass:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
.........
----------------------------------------------------------------------
Ran 9 tests in 0.064s

OK
</pre>
</div>
<div class="slide" id="creating-entries">
<h1>Creating Entries</h1>
<p>We still lack a way to add an entry. We need a view that will:</p>
<ul class="incremental simple">
<li>Verify that the user is authenticated</li>
<li>Accept incoming form data from a request</li>
<li>Get the data for <tt class="docutils literal">title</tt> and <tt class="docutils literal">text</tt></li>
<li>Create a new entry in the database</li>
<li>Provide feedback to the user on success or failure</li>
</ul>
<p class="incremental">Again, first come the tests.</p>
</div>
<div class="slide" id="testing-add-an-entry">
<h1>Testing Add an Entry</h1>
<p>Add this to <tt class="docutils literal">microblog_tests.py</tt>:</p>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">test_add_entries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="s">'admin'</span><span class="p">,</span> <span class="s">'secret'</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="s">'Hello'</span><span class="p">,</span>
        <span class="n">text</span><span class="o">=</span><span class="s">'This is a post'</span>
    <span class="p">),</span> <span class="n">follow_redirects</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">assert</span> <span class="s">'No entries here so far'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="s">'Hello'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
    <span class="k">assert</span> <span class="s">'This is a post'</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span>
</pre>
</div>
<div class="slide" id="id8">
<h1>Run Your Tests</h1>
<p>Verify that our test fails as expected:</p>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
F.........
======================================================================
FAIL: test_add_entries (__main__.MicroblogTestCase)
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;microblog_tests.py&quot;, line 110, in test_add_entries
    assert 'Hello' in response.data
AssertionError

----------------------------------------------------------------------
Ran 10 tests in 0.071s

FAILED (failures=1)
</pre>
</div>
<div class="slide" id="id9">
<h1>Make Them Pass</h1>
<p>We have all we need to write entries, all we lack is an endpoint (in
<tt class="docutils literal">microblog.py</tt>):</p>
<pre class="code python small literal-block">
<span class="c"># add an import</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">abort</span>

<span class="nd">&#64;app.route</span><span class="p">(</span><span class="s">'/add'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_entry</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'logged_in'</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">write_entry</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'title'</span><span class="p">],</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s">'text'</span><span class="p">])</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'New entry was successfully posted'</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">flash</span><span class="p">(</span><span class="s">'There was an error: </span><span class="si">%s</span><span class="s">'</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">'show_entries'</span><span class="p">))</span>
</pre>
</div>
<div class="slide" id="and">
<h1>And...?</h1>
<pre class="small literal-block">
(flaskenv)$ python microblog_tests.py
..........
----------------------------------------------------------------------
Ran 10 tests in 0.075s

OK
</pre>
<p class="incremental center"><strong>Hooray!</strong></p>
</div>
<div class="slide" id="where-do-entries-come-from">
<h1>Where do Entries Come From</h1>
<p>Finally, we're almost done. We can log in and log out. We can add entries and
view them. But look at that last view. Do you see a call to
<tt class="docutils literal">render_template</tt> in there at all?</p>
<p class="incremental">There isn't one. That's because that view is never meant to be be visible.
Look carefully at the logic. What happens?</p>
<p class="incremental">So where do the form values come from?</p>
<p class="incremental">Let's add a form to the main view.  Open <tt class="docutils literal">show_entries.html</tt></p>
</div>
<div class="slide" id="provide-a-form">
<h1>Provide a Form</h1>
<pre class="code jinja small literal-block">
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span><span class="x">  &lt;!-- already there --&gt;
</span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">session.logged_in</span> <span class="cp">%}</span><span class="x">
&lt;form action=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'add_entry'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; method=&quot;POST&quot; class=&quot;add_entry&quot;&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label for=&quot;title&quot;&gt;Title&lt;/label&gt;
    &lt;input type=&quot;text&quot; size=&quot;30&quot; name=&quot;title&quot; id=&quot;title&quot;/&gt;
  &lt;/div&gt;
  &lt;div class=&quot;field&quot;&gt;
    &lt;label for=&quot;text&quot;&gt;Text&lt;/label&gt;
    &lt;textarea name=&quot;text&quot; id=&quot;text&quot; rows=&quot;5&quot; cols=&quot;80&quot;&gt;&lt;/textarea&gt;
  &lt;/div&gt;
  &lt;div class=&quot;control_row&quot;&gt;
    &lt;input type=&quot;submit&quot; value=&quot;Share&quot; name=&quot;Share&quot;/&gt;
  &lt;/div&gt;
&lt;/form&gt;
</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x">
&lt;h2&gt;Posts&lt;/h2&gt;  &lt;!-- already there --&gt;</span>
</pre>
</div>
<div class="slide" id="all-done">
<h1>All Done</h1>
<p>Okay.  That's it.  We've got an app all written.</p>
<p class="incremental">So far, we haven't actually touched our browsers at all, but we have
reasonable certainty that this works because of our tests. Let's try it.</p>
<p class="incremental">In the terminal where you've been running tests, run our microblog app:</p>
<pre class="incremental literal-block">
(flaskenv)$ python microblog.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
</pre>
</div>
<div class="slide" id="the-big-payoff">
<h1>The Big Payoff</h1>
<p>Now load <tt class="docutils literal"><span class="pre">http://localhost:5000/</span></tt> in your browser and enjoy your reward.</p>
</div>
<div class="slide" id="making-it-pretty">
<h1>Making It Pretty</h1>
<p>What we've got here is pretty ugly.</p>
<p class="incremental">If you've fallen behind, or want to start fresh, you can find the finished
<tt class="docutils literal">microblog</tt> directory in the class resources.</p>
<p class="incremental">In that directory inside the <tt class="docutils literal">static</tt> directory you will find
<tt class="docutils literal">styles.css</tt>. Open it in your editor.  It contains basic CSS for this app.</p>
<p class="incremental">We'll need to include this file in our <tt class="docutils literal">layout.html</tt>.</p>
</div>
<div class="slide" id="static-files">
<h1>Static Files</h1>
<p>Like page templates, Flask locates static resources like images, css and
javascript by looking for a <tt class="docutils literal">static</tt> directory relative to the app root.</p>
<p class="incremental">You can use the special url endpoint <tt class="docutils literal">static</tt> to build urls that point here.
Open <tt class="docutils literal">layout.html</tt> and add the following:</p>
<pre class="code jinja small incremental literal-block">
<span class="x">&lt;head&gt;  &lt;!-- you only need to add the &lt;link&gt; below --&gt;
  &lt;title&gt;Flaskr&lt;/title&gt;
  &lt;link href=&quot;</span><span class="cp">{{</span> <span class="nv">url_for</span><span class="o">(</span><span class="s1">'static'</span><span class="o">,</span> <span class="nv">filename</span><span class="o">=</span><span class="s1">'style.css'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot;&gt;
&lt;/head&gt;</span>
</pre>
</div>
<div class="slide" id="going-further">
<h1>Going Further</h1>
<p>It's not too hard to see ways you could improve this.</p>
<ul class="incremental simple">
<li>For my part, I made a version with styles from Bootstrap.js.</li>
<li>You could limit the number of posts shown on the front page and add
pagination.</li>
<li>You could add <em>created date</em> to the entry schema and provide archived views
for older posts.</li>
<li>You could add the ability to edit existing posts (and add a modified date to
the schema)</li>
<li>You could support multi-user blogging by providing a more complex
authentication system and some more views.</li>
</ul>
</div>
<div class="slide" id="wrap-up">
<h1>Wrap-Up</h1>
<p>For educational purposes you might try taking a look at the source code for
Flask and Werkzeug.  Neither is too large a package.</p>
<p class="incremental">In particular seeing how Werkzeug sets up a Request and Response--and how
these relate to the WSGI specification--can be very enlightening.</p>
<p class="incremental center"><strong>See You Tomorrow!</strong></p>
</div>
</div>
</body>
</html>
