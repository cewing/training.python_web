<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.9.1: http://docutils.sourceforge.net/" />
<meta name="version" content="S5 1.1" />
<title>Python Web Programming</title>
<link rel="stylesheet" href="ui/uw_pce_theme/pretty.css" type="text/css" />
<!-- configuration parameters -->
<meta name="defaultView" content="slideshow" />
<meta name="controlVis" content="hidden" />
<!-- style sheet links -->
<script src="ui/uw_pce_theme/slides.js" type="text/javascript"></script>
<link rel="stylesheet" href="ui/uw_pce_theme/slides.css"
      type="text/css" media="projection" id="slideProj" />
<link rel="stylesheet" href="ui/uw_pce_theme/outline.css"
      type="text/css" media="screen" id="outlineStyle" />
<link rel="stylesheet" href="ui/uw_pce_theme/print.css"
      type="text/css" media="print" id="slidePrint" />
<link rel="stylesheet" href="ui/uw_pce_theme/opera.css"
      type="text/css" media="projection" id="operaFix" />
</head>
<body>
<div class="layout">
<div id="controls"></div>
<div id="currentSlide"></div>
<div id="header">

</div>
<div id="footer">
<h1>Python Web Programming</h1>
<h2><a class="reference external" href="http://github.com/cewing/training.python_web">View document source</a>.
</h2>
</div>
</div>
<div class="presentation">
<div class="slide" id="slide0">
<h1 class="title">Python Web Programming</h1>

<img alt="img/gateway.jpg" class="align-left" src="img/gateway.jpg" style="width: 50%;" />
<p>Session 4: CGI, WSGI and Living Online</p>
<p class="intro-blurb">Wherein we discover the gateways to dynamic processes on a server.</p>
<p class="image-credit">image: The Wandering Angel <a class="reference external" href="http://www.flickr.com/photos/wandering_angel/1467802750/">http://www.flickr.com/photos/wandering_angel/1467802750/</a> - CC-BY</p>

</div>
<div class="slide" id="yesterday">
<h1>Yesterday</h1>
<ul class="incremental simple">
<li>We learned about passing messages back and forth with sockets</li>
<li>We created a simple HTTP server using sockets</li>
<li>We may even have made our server <em>dynamic</em> by returning the output of a
python script.</li>
</ul>
<p class="incremental">What if we want to pass information to that script?</p>
<p class="incremental">How do we let the script have access to information about the HTTP request
itself?</p>
</div>
<div class="slide" id="stepping-away">
<h1>Stepping Away</h1>
<p>A computer has an <em>environment</em>:</p>
<div class="incremental container">
<p>in *nix, you can see this in a shell:</p>
<pre class="small literal-block">
$ printenv
TERM_PROGRAM=iTerm.app
...
</pre>
</div>
<div class="incremental container">
<p>or in Windows at the command prompt:</p>
<pre class="small literal-block">
C:\&gt; set
ALLUSERSPROFILE=C:\ProgramData
...
</pre>
</div>
</div>
<div class="slide" id="setting-the-environment">
<h1>Setting The Environment</h1>
<p>This can be manipulated:</p>
<div class="incremental container">
<p>In a <tt class="docutils literal">bash</tt> shell we can do this:</p>
<pre class="small literal-block">
$ export VARIABLE='some value'
$ echo $VARIABLE
some value
</pre>
</div>
<div class="incremental container">
<p>or at a Windows command prompt:</p>
<pre class="small literal-block">
C:\Users\Administrator\&gt; set VARIABLE='some value'
C:\Users\Administrator\&gt; echo %VARIABLE%
'some value'
</pre>
</div>
</div>
<div class="slide" id="viewing-the-results">
<h1>Viewing the Results</h1>
<p>These new values are now part of the <em>environment</em></p>
<div class="incremental container">
<p>*nix:</p>
<pre class="small literal-block">
$ printenv
TERM_PROGRAM=iTerm.app
...
VARIABLE=some value
</pre>
</div>
<div class="incremental container">
<p>Windows:</p>
<pre class="small literal-block">
C:\&gt; set
ALLUSERSPROFILE=C:\ProgramData
...
VARIABLE='some value'
</pre>
</div>
</div>
<div class="slide" id="environment-in-python">
<h1>Environment in Python</h1>
<p>We can see this <em>environment</em> in Python, too:</p>
<pre class="literal-block">
$ python
</pre>
<pre class="code python literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">os</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'VARIABLE'</span><span class="p">]</span>
<span class="n">some_value</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="p">[</span><span class="s">'VERSIONER_PYTHON_PREFER_32_BIT'</span><span class="p">,</span> <span class="s">'VARIABLE'</span><span class="p">,</span>
 <span class="s">'LOGNAME'</span><span class="p">,</span> <span class="s">'USER'</span><span class="p">,</span> <span class="s">'PATH'</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre>
</div>
<div class="slide" id="altering-the-environment">
<h1>Altering the Environment</h1>
<p>You can alter os environment values while in Python:</p>
<pre class="code python small literal-block">
<span class="o">&gt;&gt;&gt;</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'VARIABLE'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'new_value'</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'VARIABLE'</span><span class="p">]</span>
<span class="n">new_value</span>
</pre>
<div class="incremental container">
<p>But that doesn't change the original value, <em>outside</em> Python:</p>
<pre class="small literal-block">
&gt;&gt;&gt; ^D

$ echo this is the value: $VARIABLE
this is the value: some_value
&lt;OR&gt;
C:\&gt; \Users\Administrator\&gt; echo %VARIABLE%
'some value'
</pre>
</div>
</div>
<div class="slide" id="lessons-learned">
<h1>Lessons Learned</h1>
<ul class="incremental simple">
<li>Subprocesses inherit their environment from their Parent</li>
<li>Parents do not see changes to environment in subprocesses</li>
<li>In Python, you can actually set the environment for a subprocess explicitly</li>
</ul>
<pre class="incremental small literal-block">
subprocess.Popen(args, bufsize=0, executable=None,
                 stdin=None, stdout=None, stderr=None,
                 preexec_fn=None, close_fds=False,
                 shell=False, cwd=None, env=None, # &lt;-------
                 universal_newlines=False, startupinfo=None,
                 creationflags=0)
</pre>
</div>
<div class="slide" id="web-environment">
<h1>Web Environment</h1>
<p class="big-centered">CGI is little more than a set of standard environmental variables</p>
</div>
<div class="slide" id="rfc-3875">
<h1>RFC 3875</h1>
<p>First discussed in 1993, formalized in 1997, the current version (1.1) has
been in place since 2004.</p>
<p>From the preamble:</p>
<p class="center"><em>This memo provides information for the Internet community. It does not specify
an Internet standard of any kind.</em></p>
<p class="image-credit">RFC 3875 - CGI Version 1.1: <a class="reference external" href="http://tools.ietf.org/html/rfc3875">http://tools.ietf.org/html/rfc3875</a></p>
</div>
<div class="slide" id="meta-variables">
<h1>Meta-Variables</h1>
<pre class="small literal-block">
4.  The CGI Request . . . . . . . . . . . . . . . . . . . . . . .  10
    4.1. Request Meta-Variables . . . . . . . . . . . . . . . . .  10
         4.1.1.  AUTH_TYPE. . . . . . . . . . . . . . . . . . . .  11
         4.1.2.  CONTENT_LENGTH . . . . . . . . . . . . . . . . .  12
         4.1.3.  CONTENT_TYPE . . . . . . . . . . . . . . . . . .  12
         4.1.4.  GATEWAY_INTERFACE. . . . . . . . . . . . . . . .  13
         4.1.5.  PATH_INFO. . . . . . . . . . . . . . . . . . . .  13
         4.1.6.  PATH_TRANSLATED. . . . . . . . . . . . . . . . .  14
         4.1.7.  QUERY_STRING . . . . . . . . . . . . . . . . . .  15
         4.1.8.  REMOTE_ADDR. . . . . . . . . . . . . . . . . . .  15
         4.1.9.  REMOTE_HOST. . . . . . . . . . . . . . . . . . .  16
         4.1.10. REMOTE_IDENT . . . . . . . . . . . . . . . . . .  16
         4.1.11. REMOTE_USER. . . . . . . . . . . . . . . . . . .  16
         4.1.12. REQUEST_METHOD . . . . . . . . . . . . . . . . .  17
         4.1.13. SCRIPT_NAME. . . . . . . . . . . . . . . . . . .  17
         4.1.14. SERVER_NAME. . . . . . . . . . . . . . . . . . .  17
         4.1.15. SERVER_PORT. . . . . . . . . . . . . . . . . . .  18
         4.1.16. SERVER_PROTOCOL. . . . . . . . . . . . . . . . .  18
         4.1.17. SERVER_SOFTWARE. . . . . . . . . . . . . . . . .  19
</pre>
</div>
<div class="slide" id="running-cgi">
<h1>Running CGI</h1>
<p>You have a couple of options:</p>
<ul class="incremental simple">
<li>Python Standard Library CGIHTTPServer</li>
<li>Apache</li>
<li>IIS (on Windows)</li>
<li>Some other HTTP server that implements CGI (lighttpd, ...?)</li>
</ul>
<p class="incremental">Let's keep it simple by using the Python module</p>
</div>
<div class="slide" id="preparations">
<h1>Preparations</h1>
<p>In the class resources, you'll find a directory named <tt class="docutils literal">cgi</tt>. Make a copy of
that folder in your class working directory.</p>
<p class="incremental small red">Windows Users, you will have to edit the first line of
<tt class="docutils literal"><span class="pre">cgi/cgi-bin/cgi_1.py</span></tt> to point to your python executable.</p>
<ul class="incremental simple">
<li>Open <em>two</em> terminal windows in this <tt class="docutils literal">cgi</tt> directory</li>
<li>In the first terminal, run <tt class="docutils literal">python <span class="pre">-m</span> CGIHTTPServer</tt></li>
<li>Open a web browser and load <tt class="docutils literal"><span class="pre">http://localhost:8000/</span></tt></li>
<li>Click on <em>CGI Test 1</em></li>
</ul>
</div>
<div class="slide" id="did-that-work">
<h1>Did that work?</h1>
<ul class="simple">
<li>If nothing at all happens, check your terminal window</li>
<li>Look for this: <tt class="docutils literal">OSError: [Errno 13] Permission denied</tt></li>
<li>If you see something like that, check permissions for <tt class="docutils literal"><span class="pre">cgi-bin</span></tt> <em>and</em>
<tt class="docutils literal">cgi_1.py</tt></li>
<li>The file must be executable, the directory needs to be readable <em>and</em>
executable.</li>
</ul>
<p class="incremental">Remember that you can use the bash <tt class="docutils literal">chmod</tt> command to change permissions in
*nix</p>
<p class="incremental">Windows users, use the 'properties' context menu to get to permissions, just
grant 'full'</p>
</div>
<div class="slide" id="break-it">
<h1>Break It</h1>
<p>Problems with permissions can lead to failure. So can scripting errors</p>
<ul class="incremental simple">
<li>Open <tt class="docutils literal"><span class="pre">cgi/cgi-bin/cgi_1.py</span></tt> in an editor</li>
<li>Before where it says <tt class="docutils literal">cgi.test()</tt>, add a single line:</li>
</ul>
<pre class="code python incremental literal-block">
<span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</pre>
<p class="incremental">Reload your browser, what happens now?</p>
</div>
<div class="slide" id="errors-in-cgi">
<h1>Errors in CGI</h1>
<p>CGI is famously difficult to debug.  There are reasons for this:</p>
<ul class="incremental simple">
<li>CGI is designed to provide access to runnable processes to <em>the internet</em></li>
<li>The internet is a wretched hive of scum and villainy</li>
<li>Revealing error conditions can expose data that could be exploited</li>
</ul>
</div>
<div class="slide" id="viewing-errors-in-python-cgi">
<h1>Viewing Errors in Python CGI</h1>
<p>Back in your editor, add the following lines, just below <tt class="docutils literal">import cgi</tt>:</p>
<pre class="code python incremental literal-block">
<span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</pre>
<p class="incremental">Now, reload again.</p>
</div>
<div class="slide" id="cgitb-output">
<h1>cgitb Output</h1>
<img alt="img/cgitb_output.png" class="align-center" src="img/cgitb_output.png" style="width: 100%;" />
</div>
<div class="slide" id="repair-the-error">
<h1>Repair the Error</h1>
<p>Let's fix the error from our traceback.  Edit your <tt class="docutils literal">cgi_1.py</tt> file to match:</p>
<pre class="code python small literal-block">
<span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">cgitb</span>

<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="n">cgi</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</pre>
<p class="incremental">Notice the first line of that script: <tt class="docutils literal"><span class="pre">#!/usr/bin/python</span></tt>. This is called a
<em>shebang</em> (short for hash-bang) and it tells the system what executable
program to use when running the script.</p>
</div>
<div class="slide" id="cgi-process-execution">
<h1>CGI Process Execution</h1>
<p>When a web server like <tt class="docutils literal">CGIHTTPServer</tt> or <tt class="docutils literal">Apache</tt> runs a CGI script, it
simply attempts to run the script as if it were a normal system user.  This is
just like you calling:</p>
<pre class="literal-block">
$ ./cgi_bin/cgi_1.py
</pre>
<p class="incremental">In fact try that now in your second terminal (use the real path), what do you
get?</p>
<p class="incremental small center">Windows folks, you may need <tt class="docutils literal"><span class="pre">C:\&gt;python</span> cgi_1.py</tt></p>
<p class="incremental">What is missing?</p>
</div>
<div class="slide" id="id1">
<h1>CGI Process Execution</h1>
<p>There are a couple of important facts that are related to the way CGI
processes are run:</p>
<ul class="incremental simple">
<li>The script <strong>must</strong> include a <em>shebang</em> so that the system knows how to run
it.</li>
<li>The script <strong>must</strong> be executable.</li>
<li>The <em>executable</em> named in the <em>shebang</em> will be called as the <em>nobody</em> user.</li>
<li>This is a security feature to prevent CGI scripts from running as a user
with any privileges.</li>
<li>This means that the <em>executable</em> from the script <em>shebang</em> must be one that
<em>anyone</em> can run.</li>
</ul>
</div>
<div class="slide" id="the-cgi-environment">
<h1>The CGI Environment</h1>
<p>CGI is largely a set of agreed-upon environmental variables.</p>
<p class="incremental">We've seen how environmental variables are found in python in <tt class="docutils literal">os.environ</tt></p>
<p class="incremental">We've also seen that at least some of the variables in CGI are <strong>not</strong> in the
standard set of environment variables.</p>
<p class="incremental">Where do they come from?</p>
</div>
<div class="slide" id="cgi-servers">
<h1>CGI Servers</h1>
<p>Let's find 'em.  In a terminal (on your local machine, please) fire up python:</p>
<pre class="code literal-block">
&gt;&gt;&gt; import CGIHTTPServer
&gt;&gt;&gt; CGIHTTPServer.__file__
'/big/giant/path/to/lib/python2.6/CGIHTTPServer.py'
</pre>
<p class="incremental">Copy this path and open the file it points to in your text editor</p>
</div>
<div class="slide" id="environmental-set-up">
<h1>Environmental Set Up</h1>
<p>From CGIHTTPServer.py, in the CGIHTTPServer.run_cgi method:</p>
<pre class="code python tiny literal-block">
<span class="c"># Reference: http://hoohoo.ncsa.uiuc.edu/cgi/env.html</span>
<span class="c"># XXX Much of the following could be prepared ahead of time!</span>
<span class="n">env</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">env</span><span class="p">[</span><span class="s">'SERVER_SOFTWARE'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_string</span><span class="p">()</span>
<span class="n">env</span><span class="p">[</span><span class="s">'SERVER_NAME'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_name</span>
<span class="n">env</span><span class="p">[</span><span class="s">'GATEWAY_INTERFACE'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'CGI/1.1'</span>
<span class="n">env</span><span class="p">[</span><span class="s">'SERVER_PROTOCOL'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol_version</span>
<span class="n">env</span><span class="p">[</span><span class="s">'SERVER_PORT'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_port</span><span class="p">)</span>
<span class="n">env</span><span class="p">[</span><span class="s">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span>
<span class="o">...</span>
<span class="n">ua</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">'user-agent'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">ua</span><span class="p">:</span>
    <span class="n">env</span><span class="p">[</span><span class="s">'HTTP_USER_AGENT'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ua</span>
<span class="o">...</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
<span class="o">...</span>
</pre>
</div>
<div class="slide" id="cgi-scripts">
<h1>CGI Scripts</h1>
<p>And that's it, the big secret. The server takes care of setting up the
environment so it has what is needed.</p>
<p class="incremental">Now, in reverse. How does the information that a script creates end up in your
browser?</p>
<p class="incremental">A CGI Script must print it's results to stdout.</p>
<p class="incremental">Use the same method as above to import and open the source file for the
<tt class="docutils literal">cgi</tt> module. Note what <tt class="docutils literal">test</tt> does for an example of this.</p>
</div>
<div class="slide" id="recap">
<h1>Recap:</h1>
<p>What the Server Does:</p>
<ul class="incremental small simple">
<li>parses the request</li>
<li>sets up the environment, including HTTP and SERVER variables</li>
<li>figures out if the URI points to a CGI script and runs it</li>
<li>builds an appropriate HTTP Response first line ('HTTP/1.1 200 OK\r\n')</li>
<li>appends what comes from the script on stdout and sends that back</li>
</ul>
<p>What the Script Does:</p>
<ul class="incremental small simple">
<li>names appropriate <em>executable</em> in it's <em>shebang</em> line</li>
<li>uses os.environ to read information from the HTTP request</li>
<li>builds <em>any and all</em> appropriate <strong>HTTP Headers</strong> (Content-type:,
Content-length:, ...)</li>
<li>prints headers, empty line and script output (body) to stdout</li>
</ul>
</div>
<div class="slide" id="in-class-exercise">
<h1>In-Class Exercise</h1>
<p>You've seen the output from the <tt class="docutils literal">cgi.test()</tt> method from the <tt class="docutils literal">cgi</tt> module.
Let's make our own version of this.</p>
<ul class="incremental small simple">
<li>In the directory <tt class="docutils literal"><span class="pre">cgi-bin</span></tt> you will find the file <tt class="docutils literal">cgi_2.py</tt>.</li>
<li>Open that file in your editor.</li>
<li>The script contains some html with text naming elements of the CGI
environment.</li>
<li>You should use the values in os.environ to fill in the blanks.</li>
<li>You should be able to view the results of your work by loading
<tt class="docutils literal"><span class="pre">http://localhost:8000/</span></tt> and clicking on <em>Exercise One</em></li>
</ul>
<p class="incremental center"><strong>GO</strong></p>
</div>
<div class="slide" id="user-provided-data">
<h1>User Provided Data</h1>
<p>All this is well and good, but where's the <em>dynamic</em> stuff?</p>
<p class="incremental">It'd be nice if a user could pass form data to our script for it to use.</p>
<div class="incremental container">
<p>In HTTP, these types of inputs show up in the URL <em>query</em> (the part after
the <tt class="docutils literal">?</tt>):</p>
<pre class="literal-block">
http://myhost.com/script.py?a=23&amp;b=37
</pre>
</div>
</div>
<div class="slide" id="form-data-in-cgi">
<h1>Form Data in CGI</h1>
<p>In the <tt class="docutils literal">cgi</tt> module, we get access to this with the <tt class="docutils literal">FieldStorage</tt> class:</p>
<pre class="code python incremental small literal-block">
<span class="kn">import</span> <span class="nn">cgi</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">stringval</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s">'a'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="n">listval</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">'b'</span><span class="p">)</span>
</pre>
<ul class="incremental simple">
<li>The values in the <tt class="docutils literal">FieldStorage</tt> are <em>always</em> strings</li>
<li><tt class="docutils literal">getvalue</tt> allows you to return a default, in case the field isn't present</li>
<li><tt class="docutils literal">getlist</tt> always returns a list: empty, one-valued, or as many values as
are present</li>
</ul>
</div>
<div class="slide" id="id2">
<h1>In-Class Exercise</h1>
<p>Let's create a dynamic adding machine.</p>
<ul class="incremental simple">
<li>In the <tt class="docutils literal"><span class="pre">cgi-bin</span></tt> directory you'll find <tt class="docutils literal">cgi_sums.py</tt>.</li>
<li>In the <tt class="docutils literal">index.html</tt> file in the <tt class="docutils literal">cgi</tt> directory, the third link leads to
this file.</li>
<li>You will use the structure of that link, and what you learned just now about
<tt class="docutils literal">cgi.FieldStorage</tt>.</li>
<li>Complete the cgi script in <tt class="docutils literal">cgi_sums.py</tt> so that the result of adding all
operands sent via the url query is returned.</li>
</ul>
<p class="incremental">For extra fun, return the results in <tt class="docutils literal">json</tt> format (mimetype:
'application/json').</p>
</div>
<div class="slide" id="my-solution">
<h1>My Solution</h1>
<pre class="code python small incremental literal-block">
<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">operands</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">'operand'</span><span class="p">)</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">operand</span> <span class="ow">in</span> <span class="n">operands</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">operand</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">value</span>

<span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s">'result'</span><span class="p">:</span> <span class="n">total</span><span class="p">}</span>
<span class="n">json_output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<span class="k">print</span> <span class="s">&quot;Content-Type: application/json&quot;</span>
<span class="k">print</span> <span class="s">&quot;Content-Length: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">json_output</span><span class="p">)</span>
<span class="k">print</span>
<span class="k">print</span> <span class="n">json_output</span>
</pre>
</div>
<div class="slide" id="stopping-point">
<h1>Stopping Point</h1>
<p class="big-centered">Let's take a break here, before continuing</p>
</div>
<div class="slide" id="cgi-problems">
<h1>CGI Problems</h1>
<p>CGI is great, but there are problems:</p>
<ul class="incremental simple">
<li>Code is executed <em>in a new process</em></li>
<li><strong>Every</strong> call to a CGI script starts a new process on the server</li>
<li>Starting a new process is expensive in terms of server resources</li>
<li><em>Especially for interpreted languages like Python</em></li>
</ul>
<p class="incremental">How do we overcome this problem?</p>
</div>
<div class="slide" id="alternatives-to-cgi">
<h1>Alternatives to CGI</h1>
<p>The most popular approach is to have a long-running process <em>inside</em> the
server that handles CGI scripts.</p>
<p class="incremental">FastCGI and SCGI are existing implementations of CGI in this fashion.
<strong>mod_python</strong> offers a similar capability for Python code.</p>
<ul class="incremental simple">
<li>Each of these options has a specific API</li>
<li>None are compatible with each-other</li>
<li>Code written for one is <strong>not portable</strong> to another</li>
</ul>
<p class="incremental">This makes it much more difficult to <em>share resources</em></p>
</div>
<div class="slide" id="wsgi">
<h1>WSGI</h1>
<p>Enter WSGI, the Web Server Gateway Interface.</p>
<p class="incremental">Where other alternatives are specific implementations of the CGI standard,
WSGI is itself a new standard, not an implementation.</p>
<p class="incremental">WSGI is generalized to describe a set of interactions, so that developers can
write WSGI-capable apps and deploy them on any WSGI server.</p>
<p class="incremental">Read the WSGI spec: <a class="reference external" href="http://www.python.org/dev/peps/pep-0333">http://www.python.org/dev/peps/pep-0333</a></p>
</div>
<div class="slide" id="wsgi-apps-and-servers">
<h1>WSGI: Apps and Servers</h1>
<p class="small">WSGI consists of two parts, a <em>server</em> and an <em>application</em>.</p>
<p class="small">A WSGI Server must:</p>
<ul class="incremental small simple">
<li>set up an environment, much like the one in CGI</li>
<li>provide a method <tt class="docutils literal">start_response(status, headers, exc_info=None)</tt></li>
<li>build a response body by calling an <em>application</em>, passing
<tt class="docutils literal">environment</tt> and <tt class="docutils literal">start_response</tt> as args</li>
<li>return a response with the status, headers and body</li>
</ul>
<p class="small">A WSGI Appliction must:</p>
<ul class="incremental small simple">
<li>Be a callable (function, method, class)</li>
<li>Take an environment and a <tt class="docutils literal">start_response</tt> callable as arguments</li>
<li>Call the <tt class="docutils literal">start_response</tt> method.</li>
<li>Return an iterable of 0 or more strings, which are treated as the body of
the response.</li>
</ul>
</div>
<div class="slide" id="simplified-wsgi-server">
<h1>Simplified WSGI Server</h1>
<pre class="code python small literal-block">
<span class="kn">from</span> <span class="nn">some_application</span> <span class="kn">import</span> <span class="n">simple_app</span>

<span class="k">def</span> <span class="nf">build_env</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># put together some environment info from the reqeuest</span>
    <span class="k">return</span> <span class="n">env</span>

<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">build_env</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">iterable</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="c"># send data to client here</span>

<span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
    <span class="c"># start an HTTP response, sending status and headers</span>

<span class="c"># listen for HTTP requests and pass on to handle_request()</span>
<span class="n">serve</span><span class="p">(</span><span class="n">simple_app</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="simple-wsgi-application">
<h1>Simple WSGI Application</h1>
<p>Where the simplified server above is <strong>not</strong> functional, this <em>is</em> a complete
app:</p>
<pre class="code python literal-block">
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;200 OK&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;Hello World</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">'Content-type'</span><span class="p">,</span> <span class="s">'text/plain'</span><span class="p">,</span>
                         <span class="s">'Content-length'</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">body</span><span class="p">]</span>
</pre>
</div>
<div class="slide" id="wsgi-middleware">
<h1>WSGI Middleware</h1>
<p>A third part of the puzzle is something called WSGI <em>middleware</em></p>
<ul class="incremental simple">
<li>Middleware implements both the <em>server</em> and <em>application</em> interfaces</li>
<li>Middleware acts as a server when viewed from an application</li>
<li>Middleware acts as an application when viewed from a server</li>
</ul>
<img alt="img/wsgi_middleware_onion.png" class="incremental align-center" src="img/wsgi_middleware_onion.png" style="width: 38%;" />
</div>
<div class="slide" id="flowcharts">
<h1>Flowcharts</h1>
<p>WSGI Servers:</p>
<p class="center incremental"><strong>HTTP &lt;---&gt; WSGI</strong></p>
<p class="incremental">WSGI Applications:</p>
<p class="center incremental"><strong>WSGI &lt;---&gt; app code</strong></p>
</div>
<div class="slide" id="the-whole-enchilada">
<h1>The Whole Enchilada</h1>
<p>The WSGI <em>Stack</em> can thus be expressed like so:</p>
<p class="incremental big-centered"><strong>HTTP &lt;---&gt; WSGI &lt;---&gt; app code</strong></p>
</div>
<div class="slide" id="using-wsgiref">
<h1>Using wsgiref</h1>
<p>The Python standard lib provides a reference implementation of WSGI:</p>
<img alt="img/wsgiref_flow.png" class="incremental align-center" src="img/wsgiref_flow.png" style="width: 80%;" />
</div>
<div class="slide" id="apache-mod-wsgi">
<h1>Apache mod_wsgi</h1>
<p>You can also deploy with Apache as your HTTP server, using <strong>mod_wsgi</strong>:</p>
<img alt="img/mod_wsgi_flow.png" class="incremental align-center" src="img/mod_wsgi_flow.png" style="width: 80%;" />
</div>
<div class="slide" id="proxied-wsgi-servers">
<h1>Proxied WSGI Servers</h1>
<p>Finally, it is also common to see WSGI apps deployed via a proxied WSGI
server:</p>
<img alt="img/proxy_wsgi.png" class="incremental align-center" src="img/proxy_wsgi.png" style="width: 80%;" />
</div>
<div class="slide" id="the-wsgi-environment">
<h1>The WSGI Environment</h1>
<dl class="small incremental docutils">
<dt>REQUEST_METHOD</dt>
<dd>The HTTP request method, such as &quot;GET&quot; or &quot;POST&quot;. This cannot ever be an
empty string, and so is always required.</dd>
<dt>SCRIPT_NAME</dt>
<dd>The initial portion of the request URL's &quot;path&quot; that corresponds to the
application object, so that the application knows its virtual &quot;location&quot;.
This may be an empty string, if the application corresponds to the &quot;root&quot; of
the server.</dd>
<dt>PATH_INFO</dt>
<dd>The remainder of the request URL's &quot;path&quot;, designating the virtual
&quot;location&quot; of the request's target within the application. This may be an
empty string, if the request URL targets the application root and does not
have a trailing slash.</dd>
<dt>QUERY_STRING</dt>
<dd>The portion of the request URL that follows the &quot;?&quot;, if any. May be empty or
absent.</dd>
<dt>CONTENT_TYPE</dt>
<dd>The contents of any Content-Type fields in the HTTP request. May be empty or
absent.</dd>
</dl>
</div>
<div class="slide" id="id3">
<h1>The WSGI Environment</h1>
<dl class="small docutils">
<dt>CONTENT_LENGTH</dt>
<dd>The contents of any Content-Length fields in the HTTP request. May be empty
or absent.</dd>
<dt>SERVER_NAME, SERVER_PORT</dt>
<dd>When combined with SCRIPT_NAME and PATH_INFO, these variables can be used to
complete the URL. Note, however, that HTTP_HOST, if present, should be used
in preference to SERVER_NAME for reconstructing the request URL. See the URL
Reconstruction section below for more detail. SERVER_NAME and SERVER_PORT
can never be empty strings, and so are always required.</dd>
<dt>SERVER_PROTOCOL</dt>
<dd>The version of the protocol the client used to send the request. Typically
this will be something like &quot;HTTP/1.0&quot; or &quot;HTTP/1.1&quot; and may be used by the
application to determine how to treat any HTTP request headers. (This
variable should probably be called REQUEST_PROTOCOL, since it denotes the
protocol used in the request, and is not necessarily the protocol that will
be used in the server's response. However, for compatibility with CGI we
have to keep the existing name.)</dd>
</dl>
</div>
<div class="slide" id="id4">
<h1>The WSGI Environment</h1>
<dl class="small docutils">
<dt>HTTP_ Variables</dt>
<dd>Variables corresponding to the client-supplied HTTP request headers (i.e.,
variables whose names begin with &quot;HTTP_&quot;). The presence or absence of these
variables should correspond with the presence or absence of the appropriate
HTTP header in the request.</dd>
</dl>
<p class="center incremental"><strong>Seem Familiar?</strong></p>
</div>
<div class="slide" id="a-bit-of-repetition">
<h1>A Bit of Repetition</h1>
<p>Let's start simply.  We'll begin by repeating our first CGI exercise in WSGI</p>
<ul class="incremental simple">
<li>Find the <tt class="docutils literal">wsgi</tt> directory in the class resources. Copy it to your working
directory.</li>
<li>Open the file <tt class="docutils literal">wsgi_1.py</tt> in your text editor.</li>
<li>We will fill in the missing values using the wsgi <tt class="docutils literal">environ</tt>, just as we
use <tt class="docutils literal">os.environ</tt> in cgi</li>
</ul>
<p class="incremental center"><strong>But First</strong></p>
</div>
<div class="slide" id="orientation">
<h1>Orientation</h1>
<pre class="code python small literal-block">
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">'localhost'</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre>
<p class="incremental">Note that we pass our <tt class="docutils literal">application</tt> function to the server factory</p>
<p class="incremental">We don't have to write a server, <tt class="docutils literal">wsgiref</tt> does that for us.</p>
<p class="incremental">In fact, you should <em>never</em> have to write a WSGI server.</p>
</div>
<div class="slide" id="id5">
<h1>Orientation</h1>
<pre class="code python small literal-block">
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">response_body</span> <span class="o">=</span> <span class="n">body</span> <span class="o">%</span> <span class="p">(</span>
         <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'SERVER_NAME'</span><span class="p">,</span> <span class="s">'Unset'</span><span class="p">),</span> <span class="c"># server name</span>
            <span class="o">...</span>
         <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">'200 OK'</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">'Content-Type'</span><span class="p">,</span> <span class="s">'text/html'</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">'Content-Length'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response_body</span><span class="p">)))]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">response_body</span><span class="p">]</span>
</pre>
<p class="incremental">We do not define <tt class="docutils literal">start_response</tt>, the application does that.</p>
<p class="incremental">We <em>are</em> responsible for determining the HTTP status.</p>
</div>
<div class="slide" id="running-a-wsgi-script">
<h1>Running a WSGI Script</h1>
<p>You can run this script with python:</p>
<pre class="literal-block">
$ python wsgi_1.py
</pre>
<p class="incremental">This will start a wsgi server. What host and port will it use?</p>
<p class="incremental">Point your browser at <tt class="docutils literal"><span class="pre">http://localhost:8080/</span></tt>. Did it work?</p>
<p class="incremental">Go ahead and fill in the missing bits. Use the <tt class="docutils literal">environ</tt> passed into
<tt class="docutils literal">application</tt></p>
</div>
<div class="slide" id="some-tips">
<h1>Some Tips</h1>
<p>Because WSGI is a long-running process, the file you are editing is <em>not</em>
reloaded after you edit it.</p>
<p class="incremental">You'll need to quit and re-run the script between edits.</p>
<p class="incremental">You may also want to consider using <tt class="docutils literal">print environ</tt> in your application so
you can see the dictionary.</p>
<p class="incremental">If you do that, where will the printed environment appear?</p>
</div>
<div class="slide" id="a-more-complex-example">
<h1>A More Complex Example</h1>
<p>Let's create a multi-page wsgi application. It will serve a small database of
python books.</p>
<p class="incremental">The database (with a very simple api) can be found in <tt class="docutils literal">wsgi/bookdb.py</tt></p>
<ul class="incremental simple">
<li>We'll need a listing page that shows the titles of all the books</li>
<li>Each title will link to a details page for that book</li>
<li>The details page for each book will display all the information and have a
link back to the list</li>
</ul>
</div>
<div class="slide" id="some-questions-to-ponder">
<h1>Some Questions to Ponder</h1>
<p class="incremental">When viewing our first wsgi app, do we see the name of the wsgi application
script anywhere in the URL?</p>
<p class="incremental">In our wsgi application script, how many applications did we actually have?</p>
<p class="incremental">How are we going to serve different types of information out of a single
application?</p>
</div>
<div class="slide" id="dispatch">
<h1>Dispatch</h1>
<p>We have to write an app that will map our incoming request path to some code
that can handle that request.</p>
<p class="incremental">This process is called <tt class="docutils literal">dispatch</tt>. There are many possible approaches</p>
<p class="incremental">Let's begin by designing this piece of it.</p>
<p class="incremental">Open <tt class="docutils literal">bookapp.py</tt> from the <tt class="docutils literal">wsgi</tt> folder.  We'll do our work here.</p>
</div>
<div class="slide" id="path">
<h1>PATH</h1>
<p>The wsgi environment gives us access to <em>PATH_INFO</em>, which maps to the URI the
user requested when they loaded the page.</p>
<p class="incremental">We can design the URLs that our app will use to assist us in routing.</p>
<p class="incremental">Let's declare that any request for <tt class="docutils literal">/</tt> will map to the list page</p>
<div class="incremental container">
<p>We can also say that the URL for a book will look like this:</p>
<pre class="literal-block">
http://localhost:8080/book/&lt;identifier&gt;
</pre>
</div>
</div>
<div class="slide" id="writing-resolve-path">
<h1>Writing resolve_path</h1>
<p>Let's write a function, called <tt class="docutils literal">resolve_path</tt> in our application file.</p>
<ul class="incremental simple">
<li>It should take the <em>PATH_INFO</em> value from environ as an argument.</li>
<li>It should return the function that will be called.</li>
<li>It should also return any arguments needed to call that function.</li>
<li>This implies of course that the arguments should be part of the PATH</li>
</ul>
</div>
<div class="slide" id="id6">
<h1>My Solution</h1>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">books</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r'^book/(id[\d]+)$'</span><span class="p">,</span> <span class="n">book</span><span class="p">)]</span>
    <span class="n">matchpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">regexp</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">matchpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">([])</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span>
    <span class="c"># we get here if no url matches</span>
    <span class="k">raise</span> <span class="ne">NameError</span>
</pre>
</div>
<div class="slide" id="application-updates">
<h1>Application Updates</h1>
<p>We need to hook our new router into the application.</p>
<ul class="incremental simple">
<li>The path should be extracted from <tt class="docutils literal">environ</tt>.</li>
<li>The router should be used to get a function and arguments</li>
<li>The body to return should come from calling that function with those
arguments</li>
<li>If an error is raised by calling the function, an appropriate response
should be returned</li>
<li>If the router raises a NameError, the application should return a 404
response</li>
</ul>
</div>
<div class="slide" id="id7">
<h1>My Solution</h1>
<pre class="code python small incremental literal-block">
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'PATH_INFO'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;200 OK&quot;</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;404 Not Found&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&lt;h1&gt;Not Found&lt;/h1&gt;&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;500 Internal Server Error&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&lt;h1&gt;Internal Server Error&lt;/h1&gt;&quot;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">'Content-length'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))))</span>
        <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">body</span><span class="p">]</span>
</pre>
</div>
<div class="slide" id="test-your-work">
<h1>Test Your Work</h1>
<p>Once you've got your script settled, run it:</p>
<pre class="literal-block">
$ python bookapp.py
</pre>
<p class="incremental">Then point your browser at <tt class="docutils literal"><span class="pre">http://localhost:8080/</span></tt></p>
<ul class="incremental simple">
<li><tt class="docutils literal"><span class="pre">http://localhost/book/id3</span></tt></li>
<li><tt class="docutils literal"><span class="pre">http://localhost/book/id73/</span></tt></li>
<li><tt class="docutils literal"><span class="pre">http://localhost/sponge/damp</span></tt></li>
</ul>
<p class="incremental">Did that all work as you would have expected?</p>
</div>
<div class="slide" id="building-the-list">
<h1>Building the List</h1>
<p>The function <tt class="docutils literal">books</tt> should return an html list of book titles where each
title is a link to the detail page for that book</p>
<ul class="incremental simple">
<li>You'll need all the ids and titles from the book database.</li>
<li>You'll need to build a list in HTML using this information</li>
<li>Each list item should have the book title as a link</li>
<li>The href for the link should be of the form <tt class="docutils literal"><span class="pre">/book/&lt;id&gt;</span></tt></li>
</ul>
</div>
<div class="slide" id="id8">
<h1>My Solution</h1>
<pre class="code python incremental small literal-block">
<span class="k">def</span> <span class="nf">books</span><span class="p">():</span>
    <span class="n">all_books</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">titles</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s">'&lt;h1&gt;My Bookshelf&lt;/h1&gt;'</span><span class="p">,</span> <span class="s">'&lt;ul&gt;'</span><span class="p">]</span>
    <span class="n">item_template</span> <span class="o">=</span> <span class="s">'&lt;li&gt;&lt;a href=&quot;/book/</span><span class="si">%(id)s</span><span class="s">&quot;&gt;</span><span class="si">%(title)s</span><span class="s">&lt;/a&gt;&lt;/li&gt;'</span>
    <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">all_books</span><span class="p">:</span>
        <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_template</span> <span class="o">%</span> <span class="n">book</span><span class="p">)</span>
    <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'&lt;/ul&gt;'</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</pre>
</div>
<div class="slide" id="id9">
<h1>Test Your Work</h1>
<p>Quit and then restart your application script:</p>
<pre class="literal-block">
$ python bookapp.py
</pre>
<div class="incremental container">
<p>Then reload the root of your application:</p>
<pre class="literal-block">
http://localhost:8080/
</pre>
</div>
<p class="incremental">You should see a nice list of the books in the database. Do you?</p>
<p class="incremental">Click on a link to view the detail page. Does it load without error?</p>
</div>
<div class="slide" id="showing-details">
<h1>Showing Details</h1>
<p>The next step of course is to polish up those detail pages.</p>
<ul class="incremental simple">
<li>You'll need to retrieve a single book from the database</li>
<li>You'll need to format the details about that book and return them as HTML</li>
<li>You'll need to guard against ids that do not map to books</li>
</ul>
<p class="incremental">In this last case, what's the right HTTP response code to send?</p>
</div>
<div class="slide" id="id10">
<h1>My Solution</h1>
<pre class="code python incremental small literal-block">
<span class="k">def</span> <span class="nf">book</span><span class="p">(</span><span class="n">book_id</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;
&lt;h1&gt;</span><span class="si">%(title)s</span><span class="s">&lt;/h1&gt;
&lt;table&gt;
    &lt;tr&gt;&lt;th&gt;Author&lt;/th&gt;&lt;td&gt;</span><span class="si">%(author)s</span><span class="s">&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;th&gt;Publisher&lt;/th&gt;&lt;td&gt;</span><span class="si">%(publisher)s</span><span class="s">&lt;/td&gt;&lt;/tr&gt;
    &lt;tr&gt;&lt;th&gt;ISBN&lt;/th&gt;&lt;td&gt;</span><span class="si">%(isbn)s</span><span class="s">&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;a href=&quot;/&quot;&gt;Back to the list&lt;/a&gt;
&quot;&quot;&quot;</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">title_info</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">book</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span>
    <span class="k">return</span> <span class="n">page</span> <span class="o">%</span> <span class="n">book</span>
</pre>
</div>
<div class="slide" id="revel-in-your-success">
<h1>Revel in Your Success</h1>
<p>Quit and restart your script one more time</p>
<p class="incremental">Then poke around at your application and see the good you've made</p>
<p class="incremental">And your application is portable and sharable</p>
<p class="incremental">It should run equally well under any <a class="reference external" href="http://www.wsgi.org/en/latest/applications.html">wsgi server</a></p>
</div>
<div class="slide" id="a-few-steps-further">
<h1>A Few Steps Further</h1>
<p>Next steps for an app like this might be:</p>
<ul class="simple">
<li>Create a shared full page template and incorporate it into your app</li>
<li>Improve the error handling by emitting error codes other than 404 and 500</li>
<li>Swap out the basic backend here with a different one, maybe a Web Service?</li>
<li>Think about ways to make the application less tightly coupled to the pages
it serves</li>
</ul>
</div>
<div class="slide" id="wrap-up">
<h1>Wrap-Up</h1>
<p>For educational purposes, you might wish to take a look at the source code for
the <tt class="docutils literal">wsgiref</tt> module. It's the canonical example of a simple wsgi server</p>
<blockquote>
<pre class="doctest-block">
&gt;&gt;&gt; import wsgiref
&gt;&gt;&gt; wsgiref.__file__
'/full/path/to/your/copy/of/wsgiref.py'
...
</pre>
</blockquote>
<p class="incremental center"><strong>See You Tomorrow!</strong></p>
</div>
</div>
</body>
</html>
