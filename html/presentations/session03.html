<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Session 03 &mdash; Internet Programming with Python</title>
    
    <link rel="stylesheet" href="../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Internet Programming with Python" href="../index.html" />
    <link rel="up" title="Course Presentations" href="index.html" />
    <link rel="next" title="Session 04" href="session04.html" />
    <link rel="prev" title="Session 02" href="session02.html" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head>
  <body role="document">
<div class="header">
  <div class="logo">
    <a href="../index.html">
      <img class="logo" src="../_static/logo_UW.png" alt="Logo"/>
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="session04.html" title="Session 04"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="session02.html" title="Session 02"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">UWPCE Python 200</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Course Presentations</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="session-03">
<h1>Session 03<a class="headerlink" href="#session-03" title="Permalink to this headline">¶</a></h1>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../_images/gateway.jpg"><img alt="../_images/gateway.jpg" src="../_images/gateway.jpg" style="width: 50%;" /></a>
<p class="caption"><span class="caption-text">The Wandering Angel <a class="reference external" href="http://www.flickr.com/photos/wandering_angel/1467802750/">http://www.flickr.com/photos/wandering_angel/1467802750/</a> - CC-BY</span></p>
</div>
<div class="section" id="cgi-wsgi-and-living-online">
<h2>CGI, WSGI and Living Online<a class="headerlink" href="#cgi-wsgi-and-living-online" title="Permalink to this headline">¶</a></h2>
<p>Wherein we discover the gateways to dynamic processes on a server.</p>
<div class="section" id="but-first">
<h3>But First<a class="headerlink" href="#but-first" title="Permalink to this headline">¶</a></h3>
<p class="large centered">Homework Review and Questions</p>
</div>
<div class="section" id="previously">
<h3>Previously<a class="headerlink" href="#previously" title="Permalink to this headline">¶</a></h3>
<ul class="build simple">
<li>You&#8217;ve learned about passing messages back and forth with sockets</li>
<li>You&#8217;ve created a simple HTTP server using sockets</li>
<li>You may even have made your server <em>dynamic</em> by returning the output of a
python script.</li>
</ul>
<div class="build container">
<p>What if you want to pass information to that script?</p>
<p>How can you give the script access to information about the HTTP request
itself?</p>
</div>
</div>
<div class="section" id="stepping-away-the-environment">
<h3>Stepping Away: The Environment<a class="headerlink" href="#stepping-away-the-environment" title="Permalink to this headline">¶</a></h3>
<p>A computer has an <em>environment</em>:</p>
<div class="build container">
<p>in *nix, you can see this in a shell:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>printenv
<span class="nv">TERM_PROGRAM</span><span class="o">=</span>iTerm.app
...
</pre></div>
</div>
<p>or in Windows at the command prompt:</p>
<div class="highlight-posh"><div class="highlight"><pre>C:\&gt; set
ALLUSERSPROFILE=C:\ProgramData
...
</pre></div>
</div>
<p>or in PowerShell:</p>
<div class="highlight-posh"><div class="highlight"><pre>PS C:\&gt; Get-ChildItem Env:
ALLUSERSPROFILE             C:\ProgramData
...
</pre></div>
</div>
</div>
<div class="build container">
<p>In a <code class="docutils literal"><span class="pre">bash</span></code> shell we can do this:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">VARIABLE</span><span class="o">=</span><span class="s1">&#39;some value&#39;</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$VARIABLE</span>
some value
</pre></div>
</div>
<p>or at a Windows command prompt:</p>
<div class="highlight-posh"><div class="highlight"><pre>C:\Users\Administrator\&gt; set VARIABLE=&#39;some value&#39;
C:\Users\Administrator\&gt; echo %VARIABLE%
&#39;some value&#39;
</pre></div>
</div>
<p>or in PowerShell:</p>
<div class="highlight-posh"><div class="highlight"><pre>PS C:\&gt; $env:VARIABLE = &quot;some value&quot;
PS C:\&gt; Get-ChildItem Env:VARIABLE
&#39;some value&#39;
</pre></div>
</div>
</div>
<p>These new values are now part of the <em>environment</em></p>
<div class="build container">
<p>*nix:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>printenv
...
<span class="nv">VARIABLE</span><span class="o">=</span>some value
</pre></div>
</div>
<p>Windows:</p>
<div class="highlight-posh"><div class="highlight"><pre>C:\&gt; set
...
VARIABLE=&#39;some value&#39;
</pre></div>
</div>
<p>PowerShell:</p>
<div class="highlight-posh"><div class="highlight"><pre>PS C:\&gt; Get-ChildItem Env:
...
VARIABLE                    &#39;some value&#39;
</pre></div>
</div>
</div>
<p>We can see this <em>environment</em> in Python, too:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python
</pre></div>
</div>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;VARIABLE&#39;</span><span class="p">]</span>
<span class="go">some_value</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="go">[&#39;VERSIONER_PYTHON_PREFER_32_BIT&#39;, &#39;VARIABLE&#39;,</span>
<span class="go"> &#39;LOGNAME&#39;, &#39;USER&#39;, &#39;PATH&#39;, ...]</span>
</pre></div>
</div>
<p>You can alter os environment values while in Python:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;VARIABLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;new_value&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;VARIABLE&#39;</span><span class="p">]</span>
<span class="go">new_value</span>
</pre></div>
</div>
<div class="build container">
<p>But that doesn&#8217;t change the original value, <em>outside</em> Python:</p>
<div class="highlight-bash"><div class="highlight"><pre>&gt;&gt;&gt; ^D

<span class="nv">$ </span><span class="nb">echo </span>this is the value: <span class="nv">$VARIABLE</span>
this is the value: some_value
&lt;OR&gt;
C:<span class="se">\&gt;</span> <span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\&gt;</span> <span class="nb">echo</span> %VARIABLE%
<span class="s1">&#39;some value&#39;</span>
</pre></div>
</div>
</div>
<div class="build container">
<ul class="build simple">
<li>Subprocesses inherit their environment from their Parent</li>
<li>Parents do not see changes to environment in subprocesses</li>
<li>In Python, you can actually set the environment for a subprocess explicitly</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">stdin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">preexec_fn</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c"># &lt;-------</span>
                 <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">startupinfo</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">creationflags</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="cgi-the-web-environment">
<h2>CGI - The Web Environment<a class="headerlink" href="#cgi-the-web-environment" title="Permalink to this headline">¶</a></h2>
<p class="large centered">CGI is little more than a set of standard environmental variables</p>
<div class="section" id="what-is-cgi">
<h3>What is CGI<a class="headerlink" href="#what-is-cgi" title="Permalink to this headline">¶</a></h3>
<p>First discussed in 1993, formalized in 1997, the current version (1.1) has
been in place since 2004.</p>
<p>From the preamble:</p>
<div class="highlight-python"><div class="highlight"><pre>This memo provides information for the Internet community. It does not
specify an Internet standard of any kind.

-- RFC 3875 - CGI Version 1.1: http://tools.ietf.org/html/rfc3875
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>4.  The CGI Request . . . . . . . . . . . . . . . . . . . . . . .  10
    4.1. Request Meta-Variables . . . . . . . . . . . . . . . . .  10
         4.1.1.  AUTH_TYPE. . . . . . . . . . . . . . . . . . . .  11
         4.1.2.  CONTENT_LENGTH . . . . . . . . . . . . . . . . .  12
         4.1.3.  CONTENT_TYPE . . . . . . . . . . . . . . . . . .  12
         4.1.4.  GATEWAY_INTERFACE. . . . . . . . . . . . . . . .  13
         4.1.5.  PATH_INFO. . . . . . . . . . . . . . . . . . . .  13
         4.1.6.  PATH_TRANSLATED. . . . . . . . . . . . . . . . .  14
         4.1.7.  QUERY_STRING . . . . . . . . . . . . . . . . . .  15
         4.1.8.  REMOTE_ADDR. . . . . . . . . . . . . . . . . . .  15
         4.1.9.  REMOTE_HOST. . . . . . . . . . . . . . . . . . .  16
         4.1.10. REMOTE_IDENT . . . . . . . . . . . . . . . . . .  16
         4.1.11. REMOTE_USER. . . . . . . . . . . . . . . . . . .  16
         4.1.12. REQUEST_METHOD . . . . . . . . . . . . . . . . .  17
         4.1.13. SCRIPT_NAME. . . . . . . . . . . . . . . . . . .  17
         4.1.14. SERVER_NAME. . . . . . . . . . . . . . . . . . .  17
         4.1.15. SERVER_PORT. . . . . . . . . . . . . . . . . . .  18
         4.1.16. SERVER_PROTOCOL. . . . . . . . . . . . . . . . .  18
         4.1.17. SERVER_SOFTWARE. . . . . . . . . . . . . . . . .  19
</pre></div>
</div>
</div>
<div class="section" id="running-cgi">
<h3>Running CGI<a class="headerlink" href="#running-cgi" title="Permalink to this headline">¶</a></h3>
<p>You have a couple of options:</p>
<div class="build container">
<ul class="build simple">
<li>Python Standard Library CGIHTTPServer</li>
<li>Apache</li>
<li>IIS (on Windows)</li>
<li>Some other HTTP server that implements CGI (lighttpd, ...?)</li>
</ul>
<p>Let&#8217;s keep it simple by using the Python module</p>
</div>
<p>In the class resources for this session, you&#8217;ll find a directory named <code class="docutils literal"><span class="pre">cgi</span></code>.</p>
<div class="build container">
<p>Make a copy of that folder in your class working directory.</p>
<p>Windows Users, you may have to edit the first line of
<code class="docutils literal"><span class="pre">cgi/cgi-bin/cgi_1.py</span></code> to point to your python executable.</p>
<ul class="build simple">
<li>Open <em>two</em> terminal windows in this <code class="docutils literal"><span class="pre">cgi</span></code> directory</li>
<li>In the first terminal, run <code class="docutils literal"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">http.server</span> <span class="pre">--cgi</span></code></li>
<li>Open a web browser and load <code class="docutils literal"><span class="pre">http://localhost:8000/</span></code></li>
<li>Click on <em>CGI Test 1</em></li>
</ul>
</div>
<ul class="build simple">
<li>Your browser might show a 404 or 403 error</li>
<li>If you see something like that, check the permissions for <code class="docutils literal"><span class="pre">cgi-bin</span></code> <em>and</em>
<code class="docutils literal"><span class="pre">cgi_1.py</span></code></li>
<li>The file must be executable, the <code class="docutils literal"><span class="pre">cgi-bin</span></code> directory needs to be readable
<em>and</em> executable.</li>
</ul>
<div class="build container">
<p>Remember that you can use the bash <code class="docutils literal"><span class="pre">chmod</span></code> command to change permissions
in *nix: <code class="docutils literal"><span class="pre">chmod</span> <span class="pre">a+x</span> <span class="pre">cgi-bin/cgi_1.py</span></code></p>
<p>Windows users, use the &#8216;properties&#8217; context menu to get to permissions,
just grant &#8216;full&#8217;</p>
</div>
<p>Problems with permissions can lead to failure. So can scripting errors</p>
<div class="build container">
<ul class="build simple">
<li>Open <code class="docutils literal"><span class="pre">cgi/cgi-bin/cgi_1.py</span></code> in an editor</li>
<li>Before where it says <code class="docutils literal"><span class="pre">cgi.test()</span></code>, add a single line:</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="mi">1</span> <span class="o">/</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Reload your browser, what happens now?</p>
</div>
<p>CGI is famously difficult to debug.  There are reasons for this:</p>
<ul class="build simple">
<li>CGI is designed to provide access to runnable processes to <em>the internet</em></li>
<li>The internet is a wretched hive of scum and villainy</li>
<li>Revealing error conditions can expose data that could be exploited</li>
</ul>
<p>Back in your editor, add the following lines, just below <code class="docutils literal"><span class="pre">import</span> <span class="pre">cgi</span></code>:</p>
<div class="build container">
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</pre></div>
</div>
<p>Now, reload again.</p>
</div>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/cgitb_output.png"><img alt="../_images/cgitb_output.png" src="../_images/cgitb_output.png" style="width: 100%;" /></a>
</div>
<p>Let&#8217;s fix the error from our traceback.  Edit your <code class="docutils literal"><span class="pre">cgi_1.py</span></code> file to match:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">cgitb</span>

<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="n">cgi</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<div class="build container">
<p>Notice the first line of that script: <code class="docutils literal"><span class="pre">#!/usr/bin/env</span> <span class="pre">python</span></code>.</p>
<p>This is called a <em>shebang</em> (short for hash-bang)</p>
<p>It tells the system what executable program to use when running the script.</p>
</div>
</div>
<div class="section" id="cgi-process-execution">
<h3>CGI Process Execution<a class="headerlink" href="#cgi-process-execution" title="Permalink to this headline">¶</a></h3>
<p>Servers like <code class="docutils literal"><span class="pre">http.server</span> <span class="pre">--cgi</span></code> run CGI scripts as a system user called
<code class="docutils literal"><span class="pre">nobody</span></code>.</p>
<div class="build container">
<p>This is just like you calling:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./cgi_bin/cgi_1.py
</pre></div>
</div>
<p>In fact try that now in your second terminal (use the real path), what do
you get?</p>
<p>Windows folks, you may need <code class="docutils literal"><span class="pre">C:\&gt;python</span> <span class="pre">cgi-bin/cgi_1.py</span></code></p>
<p>Notice what is missing?</p>
</div>
<p>There are a couple of important facts about CGI that derive from this:</p>
<ul class="build simple">
<li>The script <strong>must</strong> include a <em>shebang</em> so that the system knows how to run
it.</li>
<li>The script <strong>must</strong> be executable.</li>
<li>The <em>executable</em> named in the <em>shebang</em> will be called as the <em>nobody</em> user.</li>
<li>This is a security feature to prevent CGI scripts from running as a user
with any privileges.</li>
<li>This means that the <em>executable</em> from the script <em>shebang</em> must be one that
<em>anyone</em> can run.</li>
</ul>
<p>CGI is largely a set of agreed-upon environmental variables.</p>
<div class="build container">
<p>We&#8217;ve seen how environmental variables are found in python in
<code class="docutils literal"><span class="pre">os.environ</span></code></p>
<p>We&#8217;ve also seen that at least some of the variables in CGI are <strong>not</strong> part
of the system environment.</p>
<p>Where do they come from?</p>
</div>
<p>Let&#8217;s find &#8216;em.  In a terminal fire up python:</p>
<div class="build container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [1]: </span><span class="kn">from</span> <span class="nn">http</span> <span class="kn">import</span> <span class="n">server</span>
<span class="gp">In [2]: </span><span class="n">server</span><span class="o">.</span><span class="n">__file__</span>
<span class="gh">Out[2]: </span><span class="go">&#39;/Users/cewing/pythons/parts/opt/lib/python3.5/http/server.py&#39;</span>
<span class="gp">In [3]: </span><span class="o">!</span>subl <span class="s1">&#39;/Users/cewing/pythons/parts/opt/lib/python3.5/http/server.py&#39;</span>
</pre></div>
</div>
<p>If you don&#8217;t have the <code class="docutils literal"><span class="pre">subl</span></code> command, or another one that starts your
editor, copy this path and open it in your text editor.</p>
</div>
<p>From <code class="docutils literal"><span class="pre">http/server.py</span></code>, in the <code class="docutils literal"><span class="pre">CGIHTTPRequestHandler</span></code> class, in the
<code class="docutils literal"><span class="pre">run_cgi</span></code> method:</p>
<div class="tiny highlight-python"><div class="highlight"><pre><span class="n">env</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;SERVER_SOFTWARE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_string</span><span class="p">()</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_name</span>
<span class="n">env</span><span class="p">[</span><span class="s">&#39;GATEWAY_INTERFACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;CGI/1.1&#39;</span>
<span class="o">...</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_fork</span><span class="p">:</span>
    <span class="c"># Unix -- fork as we should</span>
    <span class="o">...</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fork</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="o">...</span>
        <span class="n">os</span><span class="o">.</span><span class="n">execve</span><span class="p">(</span><span class="n">scriptfile</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
    <span class="o">...</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># Non-Unix -- use subprocess</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="o">...</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdline</span><span class="p">,</span>
                         <span class="o">...</span>
                         <span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
                         <span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>And that&#8217;s it, the big secret. The server takes care of setting up the
environment so it has what is needed.</p>
<div class="build container">
<p>Now, in reverse. How does the information that a script creates end up in
your browser?</p>
<p>A CGI Script must print its results to stdout.</p>
<p>Use the same method as above to import and open the source file for the
<code class="docutils literal"><span class="pre">cgi</span></code> module. Note what <code class="docutils literal"><span class="pre">test</span></code> does for an example of this.</p>
<div class="tiny highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">environ</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Content-type: text/html&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">FieldStorage</span><span class="p">()</span>   <span class="c"># Replace with other classes to test those</span>
        <span class="n">print_directory</span><span class="p">()</span>
        <span class="n">print_arguments</span><span class="p">()</span>
        <span class="n">print_form</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
        <span class="o">...</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">print_exception</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>What the Server Does:</p>
<ul class="build simple">
<li>parses the request</li>
<li>sets up the environment, including HTTP and SERVER variables</li>
<li>sends a <code class="docutils literal"><span class="pre">HTTP/1.1</span> <span class="pre">200</span> <span class="pre">OK\r\n</span></code> first line to the client</li>
<li>figures out if the URI points to a CGI script and runs it</li>
<li>appends what comes from the script on stdout and sends that back</li>
</ul>
<p>What the Script Does:</p>
<ul class="build simple">
<li>names appropriate <em>executable</em> in the <em>shebang</em> line</li>
<li>uses os.environ to read information from the HTTP request</li>
<li>builds <em>any and all</em> extra <strong>HTTP Headers</strong> <br />
(Content-type:, Content-length:, ...)</li>
<li>prints the headers, empty line and script output (body) to stdout</li>
</ul>
</div>
<div class="section" id="in-class-exercise-i">
<h3>In-Class Exercise I<a class="headerlink" href="#in-class-exercise-i" title="Permalink to this headline">¶</a></h3>
<p>You&#8217;ve seen the output from the <code class="docutils literal"><span class="pre">cgi.test()</span></code> method from the <code class="docutils literal"><span class="pre">cgi</span></code> module.
Let&#8217;s make our own version of this.</p>
<div class="build container">
<ul class="build simple">
<li>In the directory <code class="docutils literal"><span class="pre">cgi-bin</span></code> you will find the file <code class="docutils literal"><span class="pre">cgi_2.py</span></code>.</li>
<li>Open that file in your editor.</li>
<li>The script contains some html with text containing placeholders.</li>
<li>You should use Python and the CGI environment to fill the the blanks.</li>
<li>You can view the results of your work by loading
<code class="docutils literal"><span class="pre">http://localhost:8000/</span></code> and clicking on <em>Exercise One</em></li>
</ul>
<p><strong>GO</strong></p>
</div>
</div>
<div class="section" id="getting-data-from-users">
<h3>Getting Data from Users<a class="headerlink" href="#getting-data-from-users" title="Permalink to this headline">¶</a></h3>
<p>All this is well and good, but where&#8217;s the <em>dynamic</em> stuff?</p>
<div class="build container">
<p>It&#8217;d be nice if a user could pass form data to our script for it to use.</p>
<p>In HTTP, data is often passed to the server as a part of a URL called the
<em>query string</em></p>
<p>The URL query string is formatted as <code class="docutils literal"><span class="pre">name=value</span></code> pairs, separated by the
ampersand (<code class="docutils literal"><span class="pre">&amp;</span></code>) character</p>
<p>The entire query string is separated from other parts of the URL by a
question mark:</p>
<div class="highlight-python"><div class="highlight"><pre>http://localhost:8000/cgi_bin/somescript.py?a=23&amp;b=46&amp;b=92
</pre></div>
</div>
</div>
<p>In the <code class="docutils literal"><span class="pre">cgi</span></code> module, we get access to the query string with the
<code class="docutils literal"><span class="pre">FieldStorage</span></code> class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">cgi</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">stringval</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
<span class="n">listval</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="build simple">
<li>The values in the <code class="docutils literal"><span class="pre">FieldStorage</span></code> are <em>always</em> strings</li>
<li><code class="docutils literal"><span class="pre">getvalue</span></code> allows you to return a default, in case the field isn&#8217;t present</li>
<li><code class="docutils literal"><span class="pre">getlist</span></code> always returns a list: empty, one-valued, or as many values as
are present</li>
</ul>
</div>
<div class="section" id="in-class-exercise-ii">
<h3>In-Class Exercise II<a class="headerlink" href="#in-class-exercise-ii" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s create a dynamic adding machine.</p>
<ul class="build simple">
<li>In the <code class="docutils literal"><span class="pre">cgi-bin</span></code> directory you&#8217;ll find <code class="docutils literal"><span class="pre">cgi_sums.py</span></code>.</li>
<li>In the <code class="docutils literal"><span class="pre">index.html</span></code> file in the <code class="docutils literal"><span class="pre">cgi</span></code> directory, the third link leads to
this file.</li>
<li>You will use the structure of that link, and what you learned just now about
<code class="docutils literal"><span class="pre">cgi.FieldStorage</span></code>.</li>
<li>Complete the cgi script in <code class="docutils literal"><span class="pre">cgi_sums.py</span></code> so that the result of adding all
operands sent via the url query is returned.</li>
<li>Return the results as plain text, with the appropriate <code class="docutils literal"><span class="pre">Content-Type</span></code>
header.</li>
</ul>
<div class="build highlight-python"><div class="highlight"><pre><span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">operands</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&#39;operand&#39;</span><span class="p">)</span>
<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;your total is {total}&quot;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">operands</span><span class="p">))</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">)</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unable to calculate a sum, please provide integer operands&quot;</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;Content-Type: text/plain&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&quot;Content-Length: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
<span class="k">print</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p class="centered">Let&#8217;s take a break here, before continuing</p>
</div>
</div>
<div class="section" id="wsgi">
<h2>WSGI<a class="headerlink" href="#wsgi" title="Permalink to this headline">¶</a></h2>
<p class="center large">The Web Server Gateway Interface</p>
<div class="section" id="cgi-problems">
<h3>CGI Problems<a class="headerlink" href="#cgi-problems" title="Permalink to this headline">¶</a></h3>
<p>CGI is great, but there are problems:</p>
<div class="build container">
<ul class="build simple">
<li>Code is executed <em>in a new process</em></li>
<li><strong>Every</strong> call to a CGI script starts a new process on the server</li>
<li>Starting a new process is expensive in terms of server resources</li>
<li><em>Especially for interpreted languages like Python</em></li>
</ul>
<p>How do we overcome this problem?</p>
</div>
<p>The most popular approach is to have a long-running process <em>inside</em> the
server that handles CGI scripts.</p>
<div class="build container">
<p>FastCGI and SCGI are existing implementations of CGI in this fashion.</p>
<p>The PHP scripting language works in much the same way.</p>
<p>The Apache module <strong>mod_python</strong> offers a similar capability for Python
code.</p>
<ul class="build simple">
<li>Each of these options has a specific API</li>
<li>None are compatible with each-other</li>
<li>Code written for one is <strong>not portable</strong> to another</li>
</ul>
<p>This makes it much more difficult to <em>share resources</em></p>
</div>
</div>
<div class="section" id="a-solution">
<h3>A Solution<a class="headerlink" href="#a-solution" title="Permalink to this headline">¶</a></h3>
<p>Enter WSGI, the Web Server Gateway Interface.</p>
<div class="build container">
<p>Other alternatives are specific implementations of the CGI standard.</p>
<p>WSGI is itself a new standard, not an implementation.</p>
<p>WSGI is generalized to describe a set of interactions.</p>
<p>Developers can write WSGI-capable apps and deploy them on any WSGI server.</p>
<p>Read the original WSGI spec: <a class="reference external" href="http://www.python.org/dev/peps/pep-0333">http://www.python.org/dev/peps/pep-0333</a></p>
<p>There is also an update for Python 3: <br /> <a class="reference external" href="https://www.python.org/dev/peps/pep-3333">https://www.python.org/dev/peps/pep-3333</a></p>
</div>
</div>
<div class="section" id="apps-and-servers">
<h3>Apps and Servers<a class="headerlink" href="#apps-and-servers" title="Permalink to this headline">¶</a></h3>
<p>WSGI consists of two parts, a <em>server</em> and an <em>application</em>.</p>
<div class="build container">
<div class="container">
<p>A WSGI Server must:</p>
<ul class="build simple">
<li>set up an environment, much like the one in CGI</li>
<li>provide a method <code class="docutils literal"><span class="pre">start_response(status,</span> <span class="pre">headers,</span> <span class="pre">exc_info=None)</span></code></li>
<li>build a response body by calling an <em>application</em>, passing
<code class="docutils literal"><span class="pre">environment</span></code> and <code class="docutils literal"><span class="pre">start_response</span></code> as args</li>
<li>return a response with the status, headers and body</li>
</ul>
</div>
<div class="container">
<p>A WSGI Appliction must:</p>
<ul class="build simple">
<li>Be a callable (function, method, class)</li>
<li>Take an environment and a <code class="docutils literal"><span class="pre">start_response</span></code> callable as arguments</li>
<li>Call the <code class="docutils literal"><span class="pre">start_response</span></code> method.</li>
<li>Return an <em>iterable</em> of 0 or more strings, which are treated as the
body of the response.</li>
</ul>
</div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">some_application</span> <span class="kn">import</span> <span class="n">simple_app</span>

<span class="k">def</span> <span class="nf">build_env</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="c"># put together some environment info from the reqeuest</span>
    <span class="k">return</span> <span class="n">env</span>

<span class="k">def</span> <span class="nf">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
    <span class="n">environ</span> <span class="o">=</span> <span class="n">build_env</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">iterable</span> <span class="o">=</span> <span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="c"># send data to client here</span>

<span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
    <span class="c"># start an HTTP response, sending status and headers</span>

<span class="c"># listen for HTTP requests and pass on to handle_request()</span>
<span class="n">serve</span><span class="p">(</span><span class="n">simple_app</span><span class="p">)</span>
</pre></div>
</div>
<p>Where the simplified server above is <strong>not</strong> functional, this <em>is</em> a complete
app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;200 OK&quot;</span>
    <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;Hello World</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;Content-length&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">body</span><span class="p">]</span>
</pre></div>
</div>
<p>A third part of the puzzle is something called WSGI <em>middleware</em></p>
<div class="build container">
<ul class="build simple">
<li>Middleware implements both the <em>server</em> and <em>application</em> interfaces</li>
<li>Middleware acts as a server when viewed from an application</li>
<li>Middleware acts as an application when viewed from a server</li>
</ul>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/wsgi_middleware_onion.png"><img alt="../_images/wsgi_middleware_onion.png" src="../_images/wsgi_middleware_onion.png" style="width: 38%;" /></a>
</div>
</div>
<div class="build container">
<div class="container">
<p>WSGI Servers:</p>
<p class="large centered"><strong>HTTP &lt;&#8212;&gt; WSGI</strong></p>
</div>
<div class="container">
<p>WSGI Applications:</p>
<p class="large centered"><strong>WSGI &lt;&#8212;&gt; app code</strong></p>
</div>
</div>
<p>The WSGI <em>Stack</em> can thus be expressed like so:</p>
<p class="build large centered"><strong>HTTP &lt;&#8212;&gt; WSGI &lt;&#8212;&gt; app code</strong></p>
<p>The Python standard lib provides a reference implementation of WSGI:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/wsgiref_flow.png"><img alt="../_images/wsgiref_flow.png" src="../_images/wsgiref_flow.png" style="width: 80%;" /></a>
</div>
<p>You can also deploy with Apache as your HTTP server, using <strong>mod_wsgi</strong>:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/mod_wsgi_flow.png"><img alt="../_images/mod_wsgi_flow.png" src="../_images/mod_wsgi_flow.png" style="width: 80%;" /></a>
</div>
<p>Finally, it is also common to see WSGI apps deployed via a proxied WSGI
server:</p>
<div class="figure align-center">
<a class="reference internal image-reference" href="../_images/proxy_wsgi.png"><img alt="../_images/proxy_wsgi.png" src="../_images/proxy_wsgi.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="the-wsgi-environment">
<h3>The WSGI Environment<a class="headerlink" href="#the-wsgi-environment" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>REQUEST_METHOD:</dt>
<dd>The HTTP request method, such as &#8220;GET&#8221; or &#8220;POST&#8221;. This cannot ever be an
empty string, and so is always required.</dd>
<dt>SCRIPT_NAME:</dt>
<dd>The initial portion of the request URL&#8217;s &#8220;path&#8221; that corresponds to the
application object, so that the application knows its virtual &#8220;location&#8221;.
This may be an empty string, if the application corresponds to the &#8220;root&#8221; of
the server.</dd>
<dt>PATH_INFO:</dt>
<dd>The remainder of the request URL&#8217;s &#8220;path&#8221;, designating the virtual
&#8220;location&#8221; of the request&#8217;s target within the application. This may be an
empty string, if the request URL targets the application root and does not
have a trailing slash.</dd>
<dt>QUERY_STRING:</dt>
<dd>The portion of the request URL that follows the &#8221;?&#8221;, if any. May be empty or
absent.</dd>
<dt>CONTENT_TYPE:</dt>
<dd>The contents of any Content-Type fields in the HTTP request. May be empty or
absent.</dd>
</dl>
<dl class="docutils">
<dt>CONTENT_LENGTH:</dt>
<dd>The contents of any Content-Length fields in the HTTP request. May be empty
or absent.</dd>
<dt>SERVER_NAME, SERVER_PORT:</dt>
<dd>When combined with SCRIPT_NAME and PATH_INFO, these variables can be used to
complete the URL. Note, however, that HTTP_HOST, if present, should be used
in preference to SERVER_NAME for reconstructing the request URL. See the URL
Reconstruction section below for more detail. SERVER_NAME and SERVER_PORT
can never be empty strings, and so are always required.</dd>
<dt>SERVER_PROTOCOL:</dt>
<dd>The version of the protocol the client used to send the request. Typically
this will be something like &#8220;HTTP/1.0&#8221; or &#8220;HTTP/1.1&#8221; and may be used by the
application to determine how to treat any HTTP request headers. (This
variable should probably be called REQUEST_PROTOCOL, since it denotes the
protocol used in the request, and is not necessarily the protocol that will
be used in the server&#8217;s response. However, for compatibility with CGI we
have to keep the existing name.)</dd>
</dl>
<dl class="docutils">
<dt>HTTP_ Variables:</dt>
<dd>Variables corresponding to the client-supplied HTTP request headers (i.e.,
variables whose names begin with &#8220;HTTP_&#8221;). The presence or absence of these
variables should correspond with the presence or absence of the appropriate
HTTP header in the request.</dd>
</dl>
<p class="build large centered"><strong>Seem Familiar?</strong></p>
</div>
<div class="section" id="in-class-exercise-iii">
<h3>In-Class Exercise III<a class="headerlink" href="#in-class-exercise-iii" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s start simply.  We&#8217;ll begin by repeating our first CGI exercise in WSGI</p>
<ul class="build simple">
<li>Find the <code class="docutils literal"><span class="pre">wsgi</span></code> directory in the class resources. Copy it to your working
directory.</li>
<li>Open the file <code class="docutils literal"><span class="pre">wsgi_1.py</span></code> in your text editor.</li>
<li>We will fill in the missing values using Python and the wsgi <code class="docutils literal"><span class="pre">environ</span></code>,
just as we use <code class="docutils literal"><span class="pre">os.environ</span></code> in cgi</li>
</ul>
<p class="build centered"><strong>But First</strong></p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">wsgiref.simple_server</span> <span class="kn">import</span> <span class="n">make_server</span>
    <span class="n">srv</span> <span class="o">=</span> <span class="n">make_server</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
    <span class="n">srv</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<div class="build container">
<p>Note that we pass our <code class="docutils literal"><span class="pre">application</span></code> function to the server factory</p>
<p>We don&#8217;t have to write a server, <code class="docutils literal"><span class="pre">wsgiref</span></code> does that for us.</p>
<p>In fact, you should <em>never</em> have to write a WSGI server.</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">response_body</span> <span class="o">=</span> <span class="n">body</span> <span class="o">%</span> <span class="p">(</span>
         <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SERVER_NAME&#39;</span><span class="p">,</span> <span class="s">&#39;Unset&#39;</span><span class="p">),</span> <span class="c"># server name</span>
            <span class="o">...</span>
         <span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;200 OK&#39;</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/html&#39;</span><span class="p">),</span>
                        <span class="p">(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response_body</span><span class="p">)))]</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">response_body</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<div class="build container">
<p>We do not define <code class="docutils literal"><span class="pre">start_response</span></code>, the application does that.</p>
<p>We <em>are</em> responsible for determining the HTTP status.</p>
<p>And the content we hand back <em>must</em> be <code class="docutils literal"><span class="pre">bytes</span></code>, not unicode.</p>
</div>
<p>You can run this script with python:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python wsgi_1.py
</pre></div>
</div>
<div class="build container">
<p>This will start a wsgi server. What host and port will it use?</p>
<p>Point your browser at <code class="docutils literal"><span class="pre">http://localhost:8080/</span></code>. Did it work?</p>
<p>Go ahead and fill in the missing bits. Use the <code class="docutils literal"><span class="pre">environ</span></code> passed into
<code class="docutils literal"><span class="pre">application</span></code></p>
</div>
<p>WSGI is a long-running process.</p>
<div class="build container">
<p>The file you are editing is <em>not</em> reloaded after you edit it.</p>
<p>You&#8217;ll need to quit and re-run the script between edits.</p>
<p>Notice the use of <code class="docutils literal"><span class="pre">pprint.pprint</span></code>, check your terminal for useful output.</p>
</div>
</div>
<div class="section" id="a-wsgi-application">
<h3>A WSGI Application<a class="headerlink" href="#a-wsgi-application" title="Permalink to this headline">¶</a></h3>
<p>So now we&#8217;ve learned a bit about the WSGI specification and how a WSGI
application can get data that comes in via an HTTP request.</p>
<div class="build container">
<p>Let&#8217;s create a multi-page wsgi application.</p>
<p>It will serve a small database of python books.</p>
<p>The database (with a very simple api) can be found in <code class="docutils literal"><span class="pre">wsgi/bookdb.py</span></code></p>
<ul class="build simple">
<li>We&#8217;ll need a listing page that shows the titles of all the books</li>
<li>Each title will link to a details page for that book</li>
<li>The details page for each book will display all the information and have
a link back to the list</li>
</ul>
</div>
<p>When viewing our first wsgi app, do we see the name of the wsgi application
script anywhere in the URL?</p>
<div class="build container">
<p>In our wsgi application script, how many applications did we actually have?</p>
<p>How are we going to serve different types of information out of a single
application?</p>
</div>
<p>We have to write an app that will map our incoming request path to some code
that can handle that request.</p>
<div class="build container">
<p>This process is called <code class="docutils literal"><span class="pre">dispatch</span></code>. There are many possible approaches.</p>
<p>Let&#8217;s begin by designing this piece of our app.</p>
<p>Open <code class="docutils literal"><span class="pre">bookapp.py</span></code> from the <code class="docutils literal"><span class="pre">wsgi</span></code> folder.  We&#8217;ll do our work here.</p>
</div>
<p>The wsgi environment gives us access to <em>PATH_INFO</em>.</p>
<div class="build container">
<p>This value is the URI from the client&#8217;s HTTP request.</p>
<p>We can design the URLs that our app will use to assist us in routing.</p>
<p>Let&#8217;s declare that any request for <code class="docutils literal"><span class="pre">/</span></code> will map to the list page.</p>
<div class="container">
<p>We can also say that the URL for a book will look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>http://localhost:8080/book/&lt;identifier&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="writing-resolve-path">
<h3>Writing <code class="docutils literal"><span class="pre">resolve_path</span></code><a class="headerlink" href="#writing-resolve-path" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s write a function, called <code class="docutils literal"><span class="pre">resolve_path</span></code> in our application file.</p>
<ul class="build simple">
<li>It should take the <em>PATH_INFO</em> value from environ as an argument.</li>
<li>It should return the function that will be called.</li>
<li>It should also return any arguments needed to call that function.</li>
<li>This implies of course that the arguments should be part of the PATH</li>
</ul>
<div class="build highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">resolve_path</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">books</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&#39;^book/(id[\d]+)$&#39;</span><span class="p">,</span> <span class="n">book</span><span class="p">)]</span>
    <span class="n">matchpath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">regexp</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regexp</span><span class="p">,</span> <span class="n">matchpath</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">([])</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span>
    <span class="c"># we get here if no url matches</span>
    <span class="k">raise</span> <span class="ne">NameError</span>
</pre></div>
</div>
<p>We need to hook our new dispatch function into the application.</p>
<ul class="build simple">
<li>The path should be extracted from <code class="docutils literal"><span class="pre">environ</span></code>.</li>
<li>The dispatch function should be used to get a function and arguments</li>
<li>The body to return should come from calling that function with those
arguments</li>
<li>If an error is raised by calling the function, an appropriate response
should be returned</li>
<li>If the router raises a NameError, the application should return a 404
response</li>
</ul>
<div class="build highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">resolve_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;200 OK&quot;</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;404 Not Found&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&lt;h1&gt;Not Found&lt;/h1&gt;&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;500 Internal Server Error&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&lt;h1&gt;Internal Server Error&lt;/h1&gt;&quot;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&#39;Content-length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))))</span>
        <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">body</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
<div class="section" id="test-your-work">
<h3>Test Your Work<a class="headerlink" href="#test-your-work" title="Permalink to this headline">¶</a></h3>
<p>Once you&#8217;ve got your script settled, run it:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python bookapp.py
</pre></div>
</div>
<div class="build container">
<p>Then point your browser at <code class="docutils literal"><span class="pre">http://localhost:8080/</span></code></p>
<ul class="build simple">
<li><code class="docutils literal"><span class="pre">http://localhost/book/id3</span></code></li>
<li><code class="docutils literal"><span class="pre">http://localhost/book/id73/</span></code></li>
<li><code class="docutils literal"><span class="pre">http://localhost/sponge/damp</span></code></li>
</ul>
<p>Did that all work as you would have expected?</p>
</div>
</div>
<div class="section" id="building-the-book-list">
<h3>Building the Book List<a class="headerlink" href="#building-the-book-list" title="Permalink to this headline">¶</a></h3>
<p>The function <code class="docutils literal"><span class="pre">books</span></code> should return an html list of book titles where each
title is a link to the detail page for that book</p>
<ul class="build simple">
<li>You&#8217;ll need all the ids and titles from the book database.</li>
<li>You&#8217;ll need to build a list in HTML using this information</li>
<li>Each list item should have the book title as a link</li>
<li>The href for the link should be of the form <code class="docutils literal"><span class="pre">/book/&lt;id&gt;</span></code></li>
</ul>
<div class="build highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">books</span><span class="p">():</span>
    <span class="n">all_books</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">titles</span><span class="p">()</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&lt;h1&gt;My Bookshelf&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;ul&gt;&#39;</span><span class="p">]</span>
    <span class="n">item_template</span> <span class="o">=</span> <span class="s">&#39;&lt;li&gt;&lt;a href=&quot;/book/{id}&quot;&gt;{title}&lt;/a&gt;&lt;/li&gt;&#39;</span>
    <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">all_books</span><span class="p">:</span>
        <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">book</span><span class="p">))</span>
    <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&lt;/ul&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>Test Your Work<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Quit and then restart your application script:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python bookapp.py
</pre></div>
</div>
<div class="build container">
<div class="container">
<p>Then reload the root of your application:</p>
<div class="highlight-python"><div class="highlight"><pre>http://localhost:8080/
</pre></div>
</div>
</div>
<p>You should see a nice list of the books in the database. Do you?</p>
<p>Click on a link to view the detail page. Does it load without error?</p>
</div>
</div>
<div class="section" id="showing-details">
<h3>Showing Details<a class="headerlink" href="#showing-details" title="Permalink to this headline">¶</a></h3>
<p>The next step of course is to polish up those detail pages.</p>
<div class="build container">
<ul class="build simple">
<li>You&#8217;ll need to retrieve a single book from the database</li>
<li>You&#8217;ll need to format the details about that book and return them as HTML</li>
<li>You&#8217;ll need to guard against ids that do not map to books</li>
</ul>
<p>In this last case, what&#8217;s the right HTTP response code to send?</p>
</div>
<div class="build highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">book</span><span class="p">(</span><span class="n">book_id</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;h1&gt;{title}&lt;/h1&gt;</span>
<span class="s">&lt;table&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;Author&lt;/th&gt;&lt;td&gt;{author}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;Publisher&lt;/th&gt;&lt;td&gt;{publisher}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;ISBN&lt;/th&gt;&lt;td&gt;{isbn}&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">&lt;/table&gt;</span>
<span class="s">&lt;a href=&quot;/&quot;&gt;Back to the list&lt;/a&gt;</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">DB</span><span class="o">.</span><span class="n">title_info</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">book</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NameError</span>
    <span class="k">return</span> <span class="n">page</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">book</span><span class="p">)</span>
</pre></div>
</div>
<p>Quit and restart your script one more time</p>
<div class="build container">
<p>Then poke around at your application and see the good you&#8217;ve made</p>
<p>And your application is portable and sharable</p>
<p>It should run equally well under any <a class="reference external" href="http://wsgi.readthedocs.org/en/latest/servers.html">wsgi server</a></p>
</div>
<p>Next steps for an app like this might be:</p>
<ul class="simple">
<li>Create a shared full page template and incorporate it into your app</li>
<li>Improve the error handling by emitting error codes other than 404 and 500</li>
<li>Swap out the basic backend here with a different one, maybe a Web Service?</li>
<li>Think about ways to make the application less tightly coupled to the pages
it serves</li>
</ul>
</div>
</div>
<div class="section" id="homework">
<h2>Homework<a class="headerlink" href="#homework" title="Permalink to this headline">¶</a></h2>
<div class="left container">
<p>For your homework this week, you&#8217;ll be creating a wsgi application of your
own.</p>
<div class="build container">
<p>You&#8217;ll create an online calculator that can perform several operations</p>
<p>You&#8217;ll need to support:</p>
<ul class="build simple">
<li>Addition</li>
<li>Subtraction</li>
<li>Multiplication</li>
<li>Division</li>
</ul>
<div class="container">
<p>Your users should be able to send appropriate requests and get back
proper responses:</p>
<div class="highlight-python"><div class="highlight"><pre>http://localhost:8080/multiply/3/5  =&gt; 15
http://localhost:8080/add/23/42     =&gt; 65
http://localhost:8080/divide/6/0    =&gt; HTTP &quot;400 Bad Request&quot;
</pre></div>
</div>
</div>
</div>
</div>
<div class="left container">
<p>To submit your homework:</p>
<ul class="build simple">
<li>Create a new github repository.  Call it <code class="docutils literal"><span class="pre">wsgi-calc</span></code>.</li>
<li>Add a python script to it called <code class="docutils literal"><span class="pre">calculator.py</span></code>.</li>
<li>Your script should be runnable using <code class="docutils literal"><span class="pre">$</span> <span class="pre">python</span> <span class="pre">calculator.py</span></code></li>
<li>When the script is running, I should be able to view your application in
my browser.</li>
<li>I should be able to see a home page that explains how to perform
calculations.</li>
</ul>
<div class="build container">
<p>Your repository should include a README.md file.</p>
<p>Include all instructions I need to successfully run and view your
script.</p>
<p>When you are done, send Maria and I an email with a link to your
repository.</p>
</div>
</div>
<div class="section" id="one-last-task">
<h3>One Last Task<a class="headerlink" href="#one-last-task" title="Permalink to this headline">¶</a></h3>
<p>Next week we will be installing Python packages that are not part of the
standard library.</p>
<div class="build container">
<p>This is a common occurence in web development.  But it can be hazardous.</p>
<p>In order to practice safe development I am going to ask you to read and
follow through a <a class="reference external" href="../../html/presentations/venv_intro.html">brief tutorial</a> I&#8217;ve created on the subject.</p>
<p>If you have any trouble, or if things do not work the way they are supposed
to, please reach out.  We will need this to be working next week.</p>
</div>
</div>
<div class="section" id="wrap-up">
<h3>Wrap-Up<a class="headerlink" href="#wrap-up" title="Permalink to this headline">¶</a></h3>
<p>For educational purposes, you might wish to take a look at the source code for
the <code class="docutils literal"><span class="pre">wsgiref</span></code> module. It&#8217;s the canonical example of a simple wsgi server</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">wsgiref</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">wsgiref</span><span class="o">.</span><span class="n">__file__</span>
<span class="go">&#39;/full/path/to/your/copy/of/wsgiref.py&#39;</span>
<span class="gp">...</span>
</pre></div>
</div>
<p class="build centered"><strong>See you Next Time</strong></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Session 03</a><ul>
<li><a class="reference internal" href="#cgi-wsgi-and-living-online">CGI, WSGI and Living Online</a><ul>
<li><a class="reference internal" href="#but-first">But First</a></li>
<li><a class="reference internal" href="#previously">Previously</a></li>
<li><a class="reference internal" href="#stepping-away-the-environment">Stepping Away: The Environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cgi-the-web-environment">CGI - The Web Environment</a><ul>
<li><a class="reference internal" href="#what-is-cgi">What is CGI</a></li>
<li><a class="reference internal" href="#running-cgi">Running CGI</a></li>
<li><a class="reference internal" href="#cgi-process-execution">CGI Process Execution</a></li>
<li><a class="reference internal" href="#in-class-exercise-i">In-Class Exercise I</a></li>
<li><a class="reference internal" href="#getting-data-from-users">Getting Data from Users</a></li>
<li><a class="reference internal" href="#in-class-exercise-ii">In-Class Exercise II</a></li>
</ul>
</li>
<li><a class="reference internal" href="#wsgi">WSGI</a><ul>
<li><a class="reference internal" href="#cgi-problems">CGI Problems</a></li>
<li><a class="reference internal" href="#a-solution">A Solution</a></li>
<li><a class="reference internal" href="#apps-and-servers">Apps and Servers</a></li>
<li><a class="reference internal" href="#the-wsgi-environment">The WSGI Environment</a></li>
<li><a class="reference internal" href="#in-class-exercise-iii">In-Class Exercise III</a></li>
<li><a class="reference internal" href="#a-wsgi-application">A WSGI Application</a></li>
<li><a class="reference internal" href="#writing-resolve-path">Writing <code class="docutils literal"><span class="pre">resolve_path</span></code></a></li>
<li><a class="reference internal" href="#test-your-work">Test Your Work</a></li>
<li><a class="reference internal" href="#building-the-book-list">Building the Book List</a></li>
<li><a class="reference internal" href="#id1">Test Your Work</a></li>
<li><a class="reference internal" href="#showing-details">Showing Details</a></li>
</ul>
</li>
<li><a class="reference internal" href="#homework">Homework</a><ul>
<li><a class="reference internal" href="#one-last-task">One Last Task</a></li>
<li><a class="reference internal" href="#wrap-up">Wrap-Up</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="session02.html"
                        title="previous chapter">Session 02</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="session04.html"
                        title="next chapter">Session 04</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/presentations/session03.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
  <h3>Slides</h3>
  <ul class="this-page-menu">
    <li><a href="../.././slides/presentations/session03.html"
           rel="nofollow">View as slides</a></li>
  </ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="session04.html" title="Session 04"
             >next</a> |</li>
        <li class="right" >
          <a href="session02.html" title="Session 02"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">UWPCE Python 200</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Course Presentations</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012-2016, Cris Ewing.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>