<!--
Google IO 2012/2013 HTML5 Slide Template

Authors: Eric Bidelman <ebidel@gmail.com>
         Luke Mahé <lukem@google.com>

URL: https://code.google.com/p/io-2012-slides
--><!DOCTYPE html>


<html>
<head>
  <title>Session 05 &mdash; Internet Programming with Python</title>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">-->
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
  <!--This one seems to work all the time, but really small on ipad-->
  <!--<meta name="viewport" content="initial-scale=0.4">-->
  <meta name="apple-mobile-web-app-capable" content="yes">

  
  <link rel="stylesheet" media="all"
        href="../_static/theme/css/default.css">
  <link rel="stylesheet" media="all"
        href="../_static/theme/css/hieroglyph.css">
  <link rel="stylesheet" media="only screen and (max-device-width: 480px)"
        href="../_static/theme/css/phone.css">

    
    <link rel="stylesheet" href="../_static/custom.css"
          type="text/css" />
    

    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <base target="_blank"> <!-- This amazingness opens all links in a new tab. -->
  
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>

    <script data-main="../_static/js/slides"
            src="../_static/js/require-1.0.8.min.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <link rel="top" title="Internet Programming with Python" href="../index.html" />
    <link rel="up" title="Course Presentations" href="index.html" />
    <link rel="next" title="Session 06" href="session06.html" />
    <link rel="prev" title="Session 04" href="session04.html" /> 
</head>
<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="title-slide segue nobackground">
  <aside class="gdbar"><img src="../_static/logo_UW.png"></aside>
  <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
  <hgroup class="auto-fadein">
    <h1 data-config-title><!-- populated from slide_config.json --></h1>
    <h2 data-config-subtitle><!-- populated from slide_config.json --></h2>
    <p data-config-presenter><!-- populated from slide_config.json --></p>
  </hgroup>
</slide>

  
    <slide class="title-slide segue nobackground level-1" id="session-05">
    <hgroup>
      <h1>Session 05</h1>
    </hgroup>
    <article class="">
      <a class="reference internal image-reference" href="../_images/python.png"><img alt="../_images/python.png" class="align-center" src="../_images/python.png" style="width: 43%;" /></a>



<div class="slide-no">1</div>


    </article>
  </slide>  <slide class="level-2" id="mvc-applications">
    <hgroup>
      <h2>MVC Applications</h2>
    </hgroup>
    <article class="">
      <p>Wherin we learn about the Model View Controller approach to app design and
explore data persistence in Python.</p>
<div class="figure align-center" id="id4">
<a class="reference internal image-reference" href="http://upload.wikimedia.org/wikipedia/commons/4/40/MVC_passive_view.png"><img alt="http://upload.wikimedia.org/wikipedia/commons/4/40/MVC_passive_view.png" src="http://upload.wikimedia.org/wikipedia/commons/4/40/MVC_passive_view.png" style="width: 40%;" /></a>
<p class="caption"><span class="caption-text">By Alan Evangelista (Own work) [CC0], via Wikimedia Commons</span></p>
</div>



<div class="slide-no">2</div>


    </article>
  </slide>  <slide class="level-3" id="separation-of-concerns">
    <hgroup>
      <h3>Separation of Concerns</h3>
    </hgroup>
    <article class="">
      <div class="build container">
<p>In the first part of this course, you were introduced to the concept of
<em>Object Oriented Programming</em></p>
<p>OOP was <a class="reference external" href="http://en.wikipedia.org/wiki/Object-oriented_programming#History">first formalized</a> in the 1970s in <em>Smalltalk</em>, invented by Alan
Kay at <em>Xerox PARC</em></p>
<p><em>Smalltalk</em> was also the first language which utilized the
<a class="reference external" href="http://en.wikipedia.org/wiki/Model–view–controller">Model View Controller</a> design pattern.</p>
<p>This pattern (like all <a class="reference external" href="http://en.wikipedia.org/wiki/Software_design_pattern">design patterns</a>) seeks to provide a <em>way of
thinking</em> that helps to make software design easier.</p>
<p>In this case, the goal is to help clarify the high-level <em>separation of
concerns</em> in a system.</p>
</div>



<div class="slide-no">3</div>


    </article>
  </slide>  <slide class="level-3" id="three-components">
    <hgroup>
      <h3>Three Components</h3>
    </hgroup>
    <article class="">
      <p>The pattern divides the elements of a system into three parts:</p>
<dl class="build docutils">
<dt>Model:</dt>
<dd>This component represents the <em>data</em> that comprises the system, and the
<em>logic</em> used to manipulate that data.</dd>
<dt>View:</dt>
<dd><p class="first">This component can be any <em>representation</em> of the data to the outside world:
a chart, diagram, table, user interface, etc.</p>
<p class="last">It also includes representations of the <em>actions</em> available in the system.</p>
</dd>
<dt>Controller:</dt>
<dd><p class="first">This component coordinates the Model and the View in a system.</p>
<p>It accepts input from a user and channels that input into the Model.</p>
<p class="last">It accepts information about the current state of the Model and transmits
that information to the View.</p>
</dd>
</dl>



<div class="slide-no">4</div>


    </article>
  </slide>  <slide class="level-3" id="on-the-web">
    <hgroup>
      <h3>On the Web</h3>
    </hgroup>
    <article class="">
      <p>This pattern has proven useful for thinking about the applications we build for
the web.</p>
<div class="build container">
<p>A web browser provides a convenient container for <em>views</em> of data.</p>
<p>These <em>views</em> are created by <em>controller</em> software hosted on a server.</p>
<p>This <em>controller</em> software accepts input from users via <em>HTTP requests</em>,
channeling it into a <em>data model</em>, often stored in some database.</p>
<p>The <em>controller</em> returns information about the state of the <em>data model</em> to
the user via <em>HTTP responses</em></p>
</div>



<div class="slide-no">5</div>


    </article>
  </slide>  <slide class="level-3" id="id5">
    <hgroup>
      <h3>On the Web</h3>
    </hgroup>
    <article class="">
      <p>This approach is so common, that it has been formalized into any number of <em>web
frameworks</em></p>
<div class="build container">
<p><em>Web frameworks</em> abstract away the specifics of the <em>HTTP request/response
cycle</em>, leaving simple MVC components for the developer to use.</p>
<p><em>Web frameworks</em> exist in nearly all modern languages.</p>
<p>Python has scores of them.</p>
<p>Over the weeks to come, we'll learn about two of them, <a class="reference external" href="http://www.pylonsproject.org/projects/pyramid/about">Pyramid</a> and
<a class="reference external" href="https://www.djangoproject.com/">Django</a>.</p>
</div>



<div class="slide-no">6</div>


    </article>
  </slide>  <slide class="level-3" id="a-word-about-terminology">
    <hgroup>
      <h3>A Word About Terminology</h3>
    </hgroup>
    <article class="">
      <p>Although the MVC pattern is a useful abstraction, there are a few differences
in how things are named in Python web frameworks</p>
<div class="build centered container">
<p>model &lt;--&gt; model</p>
<p>controller &lt;--&gt; view</p>
<p>view &lt;--&gt; template (or even HTTP response)</p>
<p class="left">For more on this difference, you can <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/latest/designdefense.html#pyramid-gets-its-terminology-wrong-mvc">read this</a> from the Pyramid design
documentation.</p>
</div>



<div class="slide-no">7</div>


    </article>
  </slide>  <slide class="level-2" id="our-first-application">
    <hgroup>
      <h2>Our First Application</h2>
    </hgroup>
    <article class="">
      <p class="left">But enough abstract blabbering.</p>
<div class="build left container">
<p>There's no better way to make concepts like these concrete than to build
something using them.</p>
<p>Let's make an application!</p>
<p>We're going to build a Learning Journal.</p>
<p>When we're done, you'll have a live, online application you can use to keep
note of the things you are learning about Python development.</p>
<p>We'll use one of our Python web framework to do this: <a class="reference external" href="http://www.pylonsproject.org/projects/pyramid/about">Pyramid</a></p>
</div>



<div class="slide-no">8</div>


    </article>
  </slide>  <slide class="level-3" id="id1">
    <hgroup>
      <h3>Pyramid</h3>
    </hgroup>
    <article class="">
      <p>First published in 2010, <a class="reference external" href="http://www.pylonsproject.org/projects/pyramid/about">Pyramid</a> is a powerful, flexible web framework.</p>
<div class="build container">
<p>You can create compelling one-page applications, much like in
microframeworks like Flask</p>
<p>You can also create powerful, scalable applications using the full
power of Python</p>
<p>Created by the combined powers of the teams behind Pylons and Zope</p>
<p>It represents the first true second-generation web framework in
existence.</p>
</div>



<div class="slide-no">9</div>


    </article>
  </slide>  <slide class="level-3" id="starting-the-project">
    <hgroup>
      <h3>Starting the Project</h3>
    </hgroup>
    <article class="">
      <p>The first step is to prepare for the project.</p>
<div class="build container">
<p>Begin by creating a location where you'll do your work.</p>
<p>I generally put all my work in a folder called <code class="docutils literal"><span class="pre">projects</span></code> in my home
directory:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span>
<span class="nv">$ </span>mkdir projects
<span class="nv">$ </span><span class="nb">cd </span>projects
<span class="nv">$ </span>mkdir learning-journal
<span class="nv">$ </span><span class="nb">cd </span>learning-journal
<span class="nv">$ </span><span class="nb">pwd</span>
/Users/cewing/project/learning-journal
</pre></div>
</div>
</div>



<div class="slide-no">10</div>


    </article>
  </slide>  <slide class="level-3" id="id6">
    <hgroup>
      <h3>Creating an Environment</h3>
    </hgroup>
    <article class="">
      <p>We continue our preparations by creating the virtual environment we will use
for our project.</p>
<div class="build container">
<p>Again, this will help us to keep our work here isolated from anything else
we do.</p>
<p>Remember how to make a new venv?</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>pyvenv ljenv
</pre></div>
</div>
<div class="highlight-posh"><div class="highlight"><pre>c:\Temp&gt;python -m venv myenv
</pre></div>
</div>
<p>And then, how to activate it?</p>
<div class="highlight-bash"><div class="highlight"><pre>$ source ljenv/bin/activate
(ljenv)$
</pre></div>
</div>
<div class="highlight-posh"><div class="highlight"><pre>C:&gt; ljenv/Scripts/activate.bat
</pre></div>
</div>
</div>



<div class="slide-no">11</div>


    </article>
  </slide>  <slide class="level-3" id="id7">
    <hgroup>
      <h3>Installing Pyramid</h3>
    </hgroup>
    <article class="">
      <p>Next, we install the Pyramid web framework into our new virtualenv.</p>
<div class="build container">
<p>We can do this with the <code class="docutils literal"><span class="pre">pip</span></code> in our active <code class="docutils literal"><span class="pre">ljenv</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>pip install pyramid
Collecting pyramid
  Downloading pyramid-1.5.2-py2.py3-none-any.whl <span class="o">(</span>545kB<span class="o">)</span>
    100% <span class="p">|</span><span class="c">################################| 548kB 172kB/s</span>
...
Successfully installed PasteDeploy-1.5.2 WebOb-1.4
pyramid-1.5.2 repoze.lru-0.6 translationstring-1.3
venusian-1.0 zope.deprecation-4.1.1 zope.interface-4.1.2
</pre></div>
</div>
<p>Once that is complete, we are ready to create a <em>scaffold</em> for our project.</p>
</div>



<div class="slide-no">12</div>


    </article>
  </slide>  <slide class="level-3" id="working-with-pyramid">
    <hgroup>
      <h3>Working with Pyramid</h3>
    </hgroup>
    <article class="">
      <p>Many web frameworks require at least a bit of <em>boilerplate</em> code to get
started.</p>
<div class="build container">
<p>Pyramid does not.</p>
<p>However, our application will require a database and handling that does
require some.</p>
<p>Pyramid provides a system for creating boilerplate called <code class="docutils literal"><span class="pre">pcreate</span></code>.</p>
<p>You use it to generate the skeleton for a project based on some pattern:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>pcreate -s alchemy learning_journal
Creating directory /Users/cewing/projects/learning-journal/learning_journal
...
Welcome to Pyramid.  Sorry <span class="k">for</span> the convenience.
<span class="o">===============================================================================</span>
</pre></div>
</div>
<p>Let's take a quick look at what that did</p>
</div>



<div class="slide-no">13</div>


    </article>
  </slide>  <slide class="level-3" id="id8">
    <hgroup>
      <h3>What You Get</h3>
    </hgroup>
    <article class="">
      <div class="highlight-bash"><div class="highlight"><pre>...
├── development.ini
├── learning_journal
│   ├── __init__.py
│   ├── models.py
│   ├── scripts
│   │   ├── __init__.py
│   │   └── initializedb.py
│   ├── static
...
│   ├── templates
│   │   └── mytemplate.pt
│   ├── tests.py
│   └── views.py
├── production.ini
└── setup.py
</pre></div>
</div>



<div class="slide-no">14</div>


    </article>
  </slide>  <slide class="level-3" id="id9">
    <hgroup>
      <h3>Saving Your Work</h3>
    </hgroup>
    <article class="">
      <p>You've now created something worth saving.</p>
<div class="build container">
<p>Start by initializing a new git repository in the <cite>learning_journal</cite> folder
you just created:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span><span class="nb">cd </span>learning_journal
<span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git init
Initialized empty Git repository in
 /Users/cewing/projects/learning-journal/learning_journal/.git/
</pre></div>
</div>
</div>



<div class="slide-no">15</div>


    </article>
  </slide>  <slide class="level-3" id="id10">
    <hgroup>
      <h3>Saving Your Work</h3>
    </hgroup>
    <article class="">
      <p>Check <code class="docutils literal"><span class="pre">git</span> <span class="pre">status</span></code> to see where things stand:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git status
On branch master

Initial commit

Untracked files:
  <span class="o">(</span>use <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> to include in what will be committed<span class="o">)</span>

    CHANGES.txt
    MANIFEST.in
    README.txt
    development.ini
    learning_journal/
    production.ini
    setup.py
</pre></div>
</div>



<div class="slide-no">16</div>


    </article>
  </slide>  <slide class="level-3" id="id11">
    <hgroup>
      <h3>Add the Project Code</h3>
    </hgroup>
    <article class="">
      <p>Add your work to this new repository:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git add .
<span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git status
...
Changes to be committed:
  <span class="o">(</span>use <span class="s2">&quot;git rm --cached &lt;file&gt;...&quot;</span> to unstage<span class="o">)</span>

    new file:   CHANGES.txt
    new file:   MANIFEST.in
    ...
    new file:   production.ini
    new file:   setup.py
</pre></div>
</div>



<div class="slide-no">17</div>


    </article>
  </slide>  <slide class="level-3" id="id12">
    <hgroup>
      <h3>Ignore Irrelevant Files</h3>
    </hgroup>
    <article class="">
      <p>Python creates <code class="docutils literal"><span class="pre">.pyc</span></code> files when it executes your code.</p>
<div class="build container">
<p>There are many other files you don't want or need in your repository</p>
<p>You can ignore this in <code class="docutils literal"><span class="pre">git</span></code> with the <code class="docutils literal"><span class="pre">.gitignore</span></code> file.</p>
<p>Create one now, in this same directory, and add the following basic lines:</p>
<div class="highlight-python"><div class="highlight"><pre>*.pyc
.DS_Store
</pre></div>
</div>
<p>Finally, add this new file to your repository, too.</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git add .gitignore
</pre></div>
</div>
</div>



<div class="slide-no">18</div>


    </article>
  </slide>  <slide class="level-3" id="id13">
    <hgroup>
      <h3>Make It Permanent</h3>
    </hgroup>
    <article class="">
      <p>To preserve all these changes, you'll need to commit what you've done:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git commit -m <span class="s2">&quot;initial commit of the Pyramid learning journal&quot;</span>
</pre></div>
</div>
<div class="build container">
<p>This will make a first commit here in this local repository.</p>
<p>For homework, you'll put this into GitHub, but this is enough for now.</p>
<p>Let's move on to learning about what we've built so far.</p>
</div>



<div class="slide-no">19</div>


    </article>
  </slide>  <slide class="level-3" id="id14">
    <hgroup>
      <h3>Project Structure</h3>
    </hgroup>
    <article class="">
      <p>When you ran the <code class="docutils literal"><span class="pre">pcreate</span></code> command, a new folder was created:
<code class="docutils literal"><span class="pre">learning_journal</span></code>.</p>
<div class="build container">
<p>This folder contains your <em>project</em>.</p>
<p>At the top level, you have <em>configuration</em> (.ini files)</p>
<p>You also have a file called <code class="docutils literal"><span class="pre">setup.py</span></code></p>
<p>This file turns this collection of Python code and configuration into an
<em>installable Python distribution</em></p>
<p>Let's take a moment to look over the code in that file</p>
</div>



<div class="slide-no">20</div>


    </article>
  </slide>  <slide class="level-3" id="id15">
    <hgroup>
      <h3><code class="docutils literal"><span class="pre">setup.py</span></code></h3>
    </hgroup>
    <article class="">
      <div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">find_packages</span>
<span class="o">...</span>
<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&#39;pyramid&#39;</span><span class="p">,</span>
    <span class="o">...</span> <span class="c"># packages on which this software depends (dependencies)</span>
    <span class="p">]</span>
<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;learning_journal&#39;</span><span class="p">,</span>
      <span class="n">version</span><span class="o">=</span><span class="s">&#39;0.0&#39;</span><span class="p">,</span>
      <span class="o">...</span> <span class="c"># package metadata (used by PyPI)</span>
      <span class="n">install_requires</span><span class="o">=</span><span class="n">requires</span><span class="p">,</span>
      <span class="c"># Entry points are ways that we can run our code once installed</span>
      <span class="n">entry_points</span><span class="o">=</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">      [paste.app_factory]</span>
<span class="s">      main = learning_journal:main</span>
<span class="s">      [console_scripts]</span>
<span class="s">      initialize_learning_journal_db = learning_journal.scripts.initializedb:main</span>
<span class="s">      &quot;&quot;&quot;</span><span class="p">,</span>
      <span class="p">)</span>
</pre></div>
</div>



<div class="slide-no">21</div>


    </article>
  </slide>  <slide class="level-3" id="pyramid-is-python">
    <hgroup>
      <h3>Pyramid is Python</h3>
    </hgroup>
    <article class="">
      <p>In the <code class="docutils literal"><span class="pre">__init__.py</span></code> file of your app <em>package</em>, you'll find a <code class="docutils literal"><span class="pre">main</span></code>
function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This function returns a Pyramid WSGI application.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;sqlalchemy.&#39;</span><span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">&#39;pyramid_chameleon&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">&#39;home&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
</div>
<p>Let's take a closer look at this, line by line.</p>



<div class="slide-no">22</div>


    </article>
  </slide>  <slide class="level-3" id="id16">
    <hgroup>
      <h3>System Configuration</h3>
    </hgroup>
    <article class="">
      <div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
</pre></div>
</div>
<p>Configuration is passed in to an application after being read from the
<code class="docutils literal"><span class="pre">.ini</span></code> file we saw above.</p>
<div class="build container">
<p>These files contain sections (<code class="docutils literal"><span class="pre">[app:main]</span></code>) containing <code class="docutils literal"><span class="pre">name</span> <span class="pre">=</span> <span class="pre">value</span></code>
pairs of <em>configuration data</em></p>
<p>This data is parsed with the Python
<a class="reference external" href="http://docs.python.org/2/library/configparser.html">ConfigParser</a> module.</p>
<p>The result is a dict of values:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&#39;app:main&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;pyramid.reload_templates&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="o">...</span><span class="p">},</span> <span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p>The default section of the file is passed in as <code class="docutils literal"><span class="pre">global_config</span></code>, the
section for <em>this app</em> as <code class="docutils literal"><span class="pre">settings</span></code>.</p>
</div>



<div class="slide-no">23</div>


    </article>
  </slide>  <slide class="level-3" id="id17">
    <hgroup>
      <h3>Database Configuration</h3>
    </hgroup>
    <article class="">
      <div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">engine_from_config</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">Base</span>
<span class="o">...</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;sqlalchemy.&#39;</span><span class="p">)</span>
<span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">engine</span>
</pre></div>
</div>
<p>We will use a package called <code class="docutils literal"><span class="pre">SQLAlchemy</span></code> to interact with our database.</p>
<div class="build container">
<p>Our connection is set up using settings read from the <code class="docutils literal"><span class="pre">.ini</span></code> file.</p>
<p>Can you find the settings for the database?</p>
<p>The <code class="docutils literal"><span class="pre">DBSession</span></code> ensures that each <em>database transaction</em> is tied to HTTP
requests.</p>
<p>The <code class="docutils literal"><span class="pre">Base</span></code> provides a parent class that will hook our <em>models</em> to the
database.</p>
</div>



<div class="slide-no">24</div>


    </article>
  </slide>  <slide class="level-3" id="id18">
    <hgroup>
      <h3>App Configuration</h3>
    </hgroup>
    <article class="">
      <div class="highlight-python"><div class="highlight"><pre><span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="s">&#39;pyramid_chameleon&#39;</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_static_view</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="n">cache_max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s">&#39;home&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>
<span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">()</span>
</pre></div>
</div>
<p>Pyramid controlls application-level configuration using a <code class="docutils literal"><span class="pre">Configurator</span></code> class.</p>
<div class="build container">
<p>It uses app-specific settings passed in from the <code class="docutils literal"><span class="pre">.ini</span></code> file</p>
<p>We can also <code class="docutils literal"><span class="pre">include</span></code> configuration from other add-on packages</p>
<p>Additionally, we can configure <em>routes</em> and <em>views</em> needed to connect our
application to the outside world here (more on this next week).</p>
<p>Finally, the <code class="docutils literal"><span class="pre">Configurator</span></code> instance performs a <code class="docutils literal"><span class="pre">scan</span></code> to ensure there
are no problems with what we've created.</p>
</div>



<div class="slide-no">25</div>


    </article>
  </slide>  <slide class="level-3" id="id19">
    <hgroup>
      <h3>A Last Word on Configuration</h3>
    </hgroup>
    <article class="">
      <p>We will return to the configuration of our application repeatedly over the next
sessions.</p>
<div class="build container">
<p>Pyramid configuration is powerful and flexible.</p>
<p>We'll use a few of its features</p>
<p>But there's a lot more you could (and should) learn.</p>
<p>Read about it in the <a class="reference external" href="http://docs.pylonsproject.org/projects/pyramid/en/latest/api/config.html">configuration chapter</a> of the Pyramid documentation.</p>
</div>



<div class="slide-no">26</div>


    </article>
  </slide>  <slide class="level-3" id="id20">
    <hgroup>
      <h3>Break Time</h3>
    </hgroup>
    <article class="">
      <p>Let's take a moment to rest up and absorb what we've learned.</p>
<p>When we return, we'll see how we can create <em>models</em> that will embody the data
for our Learning Journal application.</p>
<p class="centered"><strong>Pyramid Models</strong></p>



<div class="slide-no">27</div>


    </article>
  </slide>  <slide class="level-2" id="models-in-pyramid">
    <hgroup>
      <h2>Models in Pyramid</h2>
    </hgroup>
    <article class="">
      <div class="left container">
<p>The central component of MVC, the model, captures the behavior of the
application in terms of its problem domain, independent of the user
interface. The model directly manages the data, logic and rules of the
application</p>
<p>-- from the Wikipedia article on <a class="reference external" href="http://en.wikipedia.org/wiki/Model–view–controller">Model-view-controller</a></p>
</div>



<div class="slide-no">28</div>


    </article>
  </slide>  <slide class="level-3" id="models-and-orms">
    <hgroup>
      <h3>Models and ORMs</h3>
    </hgroup>
    <article class="">
      <p>In an MVC application, we define the <em>problem domain</em> by creating one or more
<em>Models</em>.</p>
<div class="build container">
<p>These capture relevant details about the information we want to preserve
and how we want to interact with it.</p>
<p>In Python-based MVC applications, these <em>Models</em> are implemented as Python
classes.</p>
<p>The individual bits of data we want to know about are <em>attributes</em> of our
classes.</p>
<p>The actions we want to take using that data are <em>methods</em> of our classes.</p>
<p>Together, we can refer to this as the <em>API</em> of our system.</p>
</div>



<div class="slide-no">29</div>


    </article>
  </slide>  <slide class="level-3" id="id21">
    <hgroup>
      <h3>Persistence</h3>
    </hgroup>
    <article class="">
      <p>It's all well and good to have a set of Python classes that represent your
system.</p>
<div class="build container">
<p>But what happens when you want to <em>save</em> information.</p>
<p>What happens to a instance of a Python class when you quit the interprer?</p>
<p>When your script stops running?</p>
<p>The code in a website runs when an HTTP request comes in from a client.</p>
<p>It stops running when an HTTP response goes back out to the client.</p>
<p>So what happens to the data in your system in-between these moments?</p>
<p>The data must be <em>persisted</em></p>
</div>



<div class="slide-no">30</div>


    </article>
  </slide>  <slide class="level-3" id="id22">
    <hgroup>
      <h3>Alternatives</h3>
    </hgroup>
    <article class="">
      <p>In the last class from part one of this series, you explored a number of
alternatives for persistence</p>
<ul class="build simple">
<li>Python Literals</li>
<li>Pickle/Shelf</li>
<li>Interchange Files (CSV, XML, INI)</li>
<li>Object Stores (ZODB, Durus)</li>
<li>NoSQL Databases (MongoDB, CouchDB)</li>
<li>SQL Databases (sqlite, MySQL, PostgreSQL, Oracle, SQLServer)</li>
</ul>
<div class="build container">
<p>Any of these might be useful for certain types of applications.</p>
<p>On the web, you tend to see two used the most:</p>
<ul class="build simple">
<li>NoSQL</li>
<li>SQL</li>
</ul>
</div>



<div class="slide-no">31</div>


    </article>
  </slide>  <slide class="level-3" id="id23">
    <hgroup>
      <h3>Choosing One</h3>
    </hgroup>
    <article class="">
      <p>How do you choose one over the other?</p>
<div class="build container">
<p>In general, the telling factor is going to be how you intend to use your
data.</p>
<p>In systems where the dominant feature is viewing/interacting with
individual objects, a NoSQL storage solution might be the best way to go.</p>
<p>In systems with objects that are related to eachother, SQL-based Relational
Databases are a better choice.</p>
<p>Our system is more like this latter type (trust me on that one for now).</p>
<p>We'll be using SQL (sqlite to start with).</p>
</div>



<div class="slide-no">32</div>


    </article>
  </slide>  <slide class="level-3" id="id24">
    <hgroup>
      <h3>Objects and Tables</h3>
    </hgroup>
    <article class="">
      <p>So we have a system where our data is captured in Python <em>objects</em></p>
<div class="build container">
<p>And a storage system where our data must be rendered as database <em>tables</em></p>
<p>Python provides a specification for interacting directly with databases:
<a class="reference external" href="https://www.python.org/dev/peps/pep-0249/">dbapi2</a></p>
<p>And there are multiple Python packages that implement this specification
for various databases:</p>
<ul class="build simple">
<li>sqlite3</li>
<li>python-mysql</li>
<li>psycopg2</li>
<li>...</li>
</ul>
<p>With these, you can write SQL to save your Python objects into your
database.</p>
</div>



<div class="slide-no">33</div>


    </article>
  </slide>  <slide class="level-3" id="id25">
    <hgroup>
      <h3>ORMs</h3>
    </hgroup>
    <article class="">
      <p>But that's a pain.</p>
<div class="build container">
<p>SQL, while not impossible, is yet another language to learn.</p>
<p>And there is a viable alternative in using an <em>Object Relational Manager</em>
(ORM)</p>
<p>An ORM provides a layer of <em>abstraction</em> between you and SQL</p>
<p>You instantiate Python objects and set attributes on them</p>
<p>The ORM handles converting data from these objects into SQL statements (and
back)</p>
</div>



<div class="slide-no">34</div>


    </article>
  </slide>  <slide class="level-3" id="sqlalchemy">
    <hgroup>
      <h3>SQLAlchemy</h3>
    </hgroup>
    <article class="">
      <p>In our project we will be using the <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/">SQLAlchemy</a> ORM.</p>
<div class="build container">
<p>You can find SQLAlchemy among the packages in <code class="docutils literal"><span class="pre">requires</span></code> in <code class="docutils literal"><span class="pre">setup.py</span></code>
in our new <code class="docutils literal"><span class="pre">learning_journal</span></code> package.</p>
<p>However, we don't yet have that code installed.</p>
<p>To do so, we will need to &quot;install&quot; our own package</p>
<p>Make sure your <code class="docutils literal"><span class="pre">ljenv</span></code> virtualenv is active and then type the following:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>python setup.py develop
running develop
running egg_info
creating learning_journal.egg-info
...
Finished processing dependencies <span class="k">for</span> learning-journal<span class="o">==</span>0.0
</pre></div>
</div>
</div>



<div class="slide-no">35</div>


    </article>
  </slide>  <slide class="level-3" id="id26">
    <hgroup>
      <h3>SQLAlchemy</h3>
    </hgroup>
    <article class="">
      <p>Once that is complete, all the <em>dependencies</em> listed in our <code class="docutils literal"><span class="pre">setup.py</span></code> will
be installed.</p>
<div class="build container">
<p>You can also install the package using <code class="docutils literal"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code></p>
<p>But using <code class="docutils literal"><span class="pre">develop</span></code> allows us to continue developing our package without
needing to re-install it every time we change something.</p>
<p>It is very similar to using the <code class="docutils literal"><span class="pre">-e</span></code> option to <code class="docutils literal"><span class="pre">pip</span></code></p>
<p>Now, we'll only need to re-run this command if we change <code class="docutils literal"><span class="pre">setup.py</span></code>
itself.</p>
</div>



<div class="slide-no">36</div>


    </article>
  </slide>  <slide class="level-3" id="id27">
    <hgroup>
      <h3>SQLAlchemy</h3>
    </hgroup>
    <article class="">
      <p>We also need to adjust our <code class="docutils literal"><span class="pre">.gitignore</span></code> file:</p>
<div class="build highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>git status
...
Untracked files:
  <span class="o">(</span>use <span class="s2">&quot;git add &lt;file&gt;...&quot;</span> to include in what will be committed<span class="o">)</span>

    learning_journal.egg-info/
</pre></div>
</div>
<div class="build container">
<p>The <code class="docutils literal"><span class="pre">egg-info</span></code> directory that was just created is an artifact of
installing a Python egg.</p>
<p>It should never be committed to a repository.</p>
<p>Let's add <code class="docutils literal"><span class="pre">*.egg-info</span></code> to our <code class="docutils literal"><span class="pre">.gitignore</span></code> file and then commit that
change</p>
<p>Remember how?</p>
</div>



<div class="slide-no">37</div>


    </article>
  </slide>  <slide class="level-3" id="id28">
    <hgroup>
      <h3>Our First Model</h3>
    </hgroup>
    <article class="">
      <p>Our project skeleton contains up a first, basic model created for us:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in models.py</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&#39;models&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
<span class="n">Index</span><span class="p">(</span><span class="s">&#39;my_index&#39;</span><span class="p">,</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mysql_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
</pre></div>
</div>
<div class="build container">
<p>Our class inherits from <code class="docutils literal"><span class="pre">Base</span></code></p>
<p>We ran into <code class="docutils literal"><span class="pre">Base</span></code> earlier when discussing configuration.</p>
<p>We were binding it to the database we wanted to use (the <code class="docutils literal"><span class="pre">engine</span></code>)</p>
</div>



<div class="slide-no">38</div>


    </article>
  </slide>  <slide class="level-3" id="id29">
    <hgroup>
      <h3><code class="docutils literal"><span class="pre">Base</span></code></h3>
    </hgroup>
    <article class="">
      <p>Any class we create that inherits from this <code class="docutils literal"><span class="pre">Base</span></code> becomes a <em>model</em></p>
<div class="build container">
<p>It will be connected through the ORM to a table in our database.</p>
<p>The name of the table is determined by the <code class="docutils literal"><span class="pre">__tablename__</span></code> special
attribute.</p>
<p>Other aspects of table configuration can also be controlled through special
attributes</p>
<p>Instances of the class, once saved, will become rows in the table.</p>
<p>Attributes of the model that are instances of <code class="docutils literal"><span class="pre">Column</span></code> will become
columns in the table.</p>
<p>You can learn much more in the <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/orm/extensions/declarative/">Declarative</a> chapter of the SQLAlchemy docs</p>
</div>



<div class="slide-no">39</div>


    </article>
  </slide>  <slide class="level-3" id="id30">
    <hgroup>
      <h3>Columns</h3>
    </hgroup>
    <article class="">
      <p>Each attribute of your model that will be persisted must be an instance of
<a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/core/metadata.html#sqlalchemy.schema.Column">Column</a>.</p>
<div class="build container">
<p>Each instance requires <em>at least</em> a specific <a class="reference external" href="http://docs.sqlalchemy.org/en/rel_0_9/core/types.html">data type</a> (such as
Integer).</p>
<p>Additionally, you can control other aspects of the column such as it being
a primary key.</p>
<p>In the <em>declarative</em> style we are using, the name of the column in the
database will default to the attribute name you assigned.</p>
<p>If you wish, you may provide a name specifically.  It must be the first
argument and must be a string.</p>
</div>



<div class="slide-no">40</div>


    </article>
  </slide>  <slide class="level-3" id="creating-the-database">
    <hgroup>
      <h3>Creating The Database</h3>
    </hgroup>
    <article class="">
      <p>We have a <em>model</em> which allows us to persist Python objects to an SQL database.</p>
<div class="build container">
<p>But we're still missing one ingredient here.</p>
<p>We need to create our database, or there will be nowhere for our data to
go.</p>
<p>Luckily, our <code class="docutils literal"><span class="pre">pcreate</span></code> scaffold also gave us a convenient way to handle
this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in setup.py</span>
<span class="n">entry_points</span><span class="o">=</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">[paste.app_factory]</span>
<span class="s">main = learning_journal:main</span>
<span class="s">[console_scripts]</span>
<span class="s">initialize_learning_journal_db = learning_journal.scripts.initializedb:main</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">console_script</span></code> set up as an entry point will help us.</p>
</div>



<div class="slide-no">41</div>


    </article>
  </slide>  <slide class="level-3" id="id31">
    <hgroup>
      <h3><code class="docutils literal"><span class="pre">initialize_learning_journal_db</span></code></h3>
    </hgroup>
    <article class="">
      <p>Let's look at that code for a moment.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in scripts/intitalizedb.py</span>
<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="n">DBSession</span><span class="p">,</span> <span class="n">MyModel</span><span class="p">,</span> <span class="n">Base</span>
<span class="c"># ...</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">usage</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">config_uri</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">parse_vars</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">setup_logging</span><span class="p">(</span><span class="n">config_uri</span><span class="p">)</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">get_appsettings</span><span class="p">(</span><span class="n">config_uri</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;sqlalchemy.&#39;</span><span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>



<div class="slide-no">42</div>


    </article>
  </slide>  <slide class="level-3" id="id32">
    <hgroup>
      <h3>Console Scripts</h3>
    </hgroup>
    <article class="">
      <p>By connecting this function as a <code class="docutils literal"><span class="pre">console</span> <span class="pre">script</span></code>, our Python package makes
this command available to us.</p>
<div class="build container">
<p>When we exectute <code class="docutils literal"><span class="pre">initialize_learning_journal_db</span></code> at the command line, we
will be running this function.</p>
<p>Let's try it out.</p>
<p>We'll need to provide a configuration file name, let's use
<code class="docutils literal"><span class="pre">development.ini</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>initialize_learning_journal_db development.ini
2015-01-05 18:59:55,426 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine<span class="o">][</span>MainThread<span class="o">]</span> SELECT CAST<span class="o">(</span><span class="s1">&#39;test plain returns&#39;</span> AS VARCHAR<span class="o">(</span>60<span class="o">))</span> AS anon_1
...
2015-01-05 18:59:55,434 INFO  <span class="o">[</span>sqlalchemy.engine.base.Engine<span class="o">][</span>MainThread<span class="o">]</span> COMMIT
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">[loggers]</span></code> configuration in our <code class="docutils literal"><span class="pre">.ini</span></code> file sends a stream of
INFO-level logging to sys.stdout as the console script runs.</p>
</div>



<div class="slide-no">43</div>


    </article>
  </slide>  <slide class="level-3" id="id33">
    <hgroup>
      <h3>A Bit More Cleanup</h3>
    </hgroup>
    <article class="">
      <p>So what was the outcome of running that script?</p>
<div class="build container">
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>ls
...
learning_journal.sqlite
...
</pre></div>
</div>
<p>We've now created an sqlite database.</p>
<p>You'll need to add <code class="docutils literal"><span class="pre">*.sqlite</span></code> to <code class="docutils literal"><span class="pre">.gitignore</span></code> so you don't
inadvertently add that file to your repository.</p>
<p>Once you've done so, commit the change to your repository</p>
</div>



<div class="slide-no">44</div>


    </article>
  </slide>  <slide class="level-3" id="interacting-with-sqla-models">
    <hgroup>
      <h3>Interacting with SQLA Models</h3>
    </hgroup>
    <article class="">
      <p>It's pretty easy to play with your models from in an interpreter.</p>
<div class="build container">
<p>But before we do so, let's make a nicer interpreter available for our
project</p>
<p>You've been using iPython in class, we can use it here too.</p>
<p>Just install it with <code class="docutils literal"><span class="pre">pip</span></code>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>pip install ipython pyramid_ipython
</pre></div>
</div>
<p>Once that finishes, you'll be able to use iPython as your interpreter for
this project.</p>
<p>And <code class="docutils literal"><span class="pre">Pyramid</span></code> provides a way to connect your interpreter to the
application code you are writing:</p>
<p>The <code class="docutils literal"><span class="pre">pshell</span></code> command</p>
</div>



<div class="slide-no">45</div>


    </article>
  </slide>  <slide class="level-3" id="id34">
    <hgroup>
      <h3>The <code class="docutils literal"><span class="pre">pshell</span></code> command</h3>
    </hgroup>
    <article class="">
      <p>Let's fire up <code class="docutils literal"><span class="pre">pshell</span></code> and explore for a moment to see what we have at our
disposal:</p>
<div class="build container">
<div class="highlight-bash"><div class="highlight"><pre><span class="o">(</span>ljenv<span class="o">)</span><span class="nv">$ </span>pshell development.ini
Python 3.5.0 <span class="o">(</span>default, Sep <span class="m">16</span> 2015, 10:42:55<span class="o">)</span>
Type <span class="s2">&quot;copyright&quot;</span>, <span class="s2">&quot;credits&quot;</span> or <span class="s2">&quot;license&quot;</span> <span class="k">for</span> more information.

IPython 4.0.1 -- An enhanced Interactive Python.
?         -&gt; Introduction and overview of IPython<span class="s1">&#39;s features.</span>
<span class="s1">%quickref -&gt; Quick reference.</span>
<span class="s1">help      -&gt; Python&#39;</span>s own <span class="nb">help </span>system.
object?   -&gt; Details about <span class="s1">&#39;object&#39;</span>, use <span class="s1">&#39;object??&#39;</span> <span class="k">for</span> extra details.

Environment:
  app          The WSGI application.
  registry     Active Pyramid registry.
  request      Active request object.
  root         Root of the default resource tree.
  root_factory Default root factory used to create <span class="sb">`</span>root<span class="sb">`</span>.
</pre></div>
</div>
</div>



<div class="slide-no">46</div>


    </article>
  </slide>  <slide class="level-3" id="id35">
    <hgroup>
      <h3>Interacting with SQLA Models</h3>
    </hgroup>
    <article class="">
      <p>The <code class="docutils literal"><span class="pre">environment</span></code> created by <code class="docutils literal"><span class="pre">pshell</span></code> provides us with a few useful tools.</p>
<div class="highlight-bash"><div class="highlight"><pre>app          The WSGI application.
registry     Active Pyramid registry.
request      Active request object.
root         Root of the default resource tree.
root_factory Default root factory used to create <span class="sb">`</span>root<span class="sb">`</span>.
</pre></div>
</div>
<ul class="build simple">
<li>The <code class="docutils literal"><span class="pre">app</span></code> is our new learning journal application</li>
<li>The <code class="docutils literal"><span class="pre">registry</span></code> provides us with access to settings and other useful
information</li>
<li>The <code class="docutils literal"><span class="pre">request</span></code> is an artificial HTTP request we can use if we need to
pretend we are listening to clients</li>
<li>...</li>
</ul>



<div class="slide-no">47</div>


    </article>
  </slide>  <slide class="level-3" id="id36">
    <hgroup>
      <h3>Interacting with SQLA Models</h3>
    </hgroup>
    <article class="">
      <p>Let's use this environment to build a database session and interact with our
data:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [1]: </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">engine_from_config</span>
<span class="gp">In [2]: </span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine_from_config</span><span class="p">(</span><span class="n">registry</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;sqlalchemy.&#39;</span><span class="p">)</span>
<span class="gp">In [3]: </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="gp">In [4]: </span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="gp">In [5]: </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="gp">In [6]: </span><span class="kn">from</span> <span class="nn">learning_journal.models</span> <span class="kn">import</span> <span class="n">MyModel</span>
<span class="gp">In [7]: </span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="go">...</span>
<span class="go">2015-12-21 18:06:05,179 INFO  [sqlalchemy.engine.base.Engine][MainThread] SELECT models.id AS models_id, models.name AS models_name, models.value AS models_value</span>
<span class="go">FROM models</span>
<span class="go">2015-12-21 18:06:05,179 INFO  [sqlalchemy.engine.base.Engine][MainThread] ()</span>
<span class="gh">Out[7]: </span><span class="go">[&lt;learning_journal.models.MyModel at 0x105f30208&gt;]</span>
</pre></div>
</div>
<p>We've stolen a lot of this from the <code class="docutils literal"><span class="pre">initializedb.py</span></code> script</p>



<div class="slide-no">48</div>


    </article>
  </slide>  <slide class="level-3" id="id37">
    <hgroup>
      <h3>Basic Interactions</h3>
    </hgroup>
    <article class="">
      <p>Any interaction with the database requires a <code class="docutils literal"><span class="pre">session</span></code>.</p>
<div class="build container">
<p>This object represents the connection to the database.</p>
<p>All database queries are phrased as methods of the session.</p>
<div class="container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [8]: </span><span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span>
<span class="gp">In [9]: </span><span class="nb">type</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
<span class="gh">Out[9]: </span><span class="go">sqlalchemy.orm.query.Query</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">query</span></code> method of the session object returns a <code class="docutils literal"><span class="pre">Query</span></code> object</p>
</div>
<p>Arguments to the <code class="docutils literal"><span class="pre">query</span></code> method can be a <em>model</em> class or <em>columns</em> from
a model class.</p>
</div>



<div class="slide-no">49</div>


    </article>
  </slide>  <slide class="level-3" id="id38">
    <hgroup>
      <h3>Queries are Iterators</h3>
    </hgroup>
    <article class="">
      <p>You can iterate over a query object. The result depends on the args you passed.</p>
<div class="build container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [10]: </span><span class="n">q1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span>
<span class="gp">In [11]: </span><span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">q1</span><span class="p">:</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
<span class="gp">   ....:</span>
<span class="go">&lt;learning_journal.models.MyModel object at 0x105f30208&gt;</span>
<span class="go">&lt;class &#39;learning_journal.models.MyModel&#39;&gt;</span>
</pre></div>
</div>
</div>



<div class="slide-no">50</div>


    </article>
  </slide>  <slide class="level-3" id="id39">
    <hgroup>
      <h3>Queries are Iterators</h3>
    </hgroup>
    <article class="">
      <p>You can iterate over a query object. The result depends on the args you passed.</p>
<blockquote>
<div><div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [12]: </span><span class="n">q2</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="gp">In [13]: </span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">q2</span><span class="p">:</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="gp">   ....: </span>    <span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
<span class="gp">   ....:</span>
<span class="go">one</span>
<span class="go">&lt;class &#39;str&#39;&gt;</span>
<span class="go">1</span>
<span class="go">&lt;class &#39;int&#39;&gt;</span>
<span class="go">1</span>
<span class="go">&lt;class &#39;int&#39;&gt;</span>
</pre></div>
</div>
</div></blockquote>



<div class="slide-no">51</div>


    </article>
  </slide>  <slide class="level-3" id="id40">
    <hgroup>
      <h3>Queries have SQL</h3>
    </hgroup>
    <article class="">
      <p>You can view the SQL that your query will use:</p>
<div class="build container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [14]: </span><span class="nb">str</span><span class="p">(</span><span class="n">q1</span><span class="p">)</span>
<span class="gh">Out[14]: </span><span class="go">&#39;SELECT models.id AS models_id, models.name AS models_name, models.value AS models_value \nFROM models&#39;</span>

<span class="gp">In [15]: </span><span class="nb">str</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>
<span class="gh">Out[15]: </span><span class="go">&#39;SELECT models.name AS models_name, models.id AS models_id, models.value AS models_value \nFROM models&#39;</span>
</pre></div>
</div>
<p>You can use this to check that the query the ORM is constructing looks like
you expect.</p>
<p>It can be helpful in debugging.</p>
</div>



<div class="slide-no">52</div>


    </article>
  </slide>  <slide class="level-3" id="id41">
    <hgroup>
      <h3>Methods of the Query Object</h3>
    </hgroup>
    <article class="">
      <p>The methods of the <code class="docutils literal"><span class="pre">Query</span></code> object fall into two rough categories</p>
<div class="build container">
<ol class="build arabic simple">
<li>Methods that return a new <code class="docutils literal"><span class="pre">Query</span></code> object</li>
<li>Methods that return <em>scalar</em> values or <em>model</em> instances</li>
</ol>
<p>Let's start by looking quickly at a few methods from the second category</p>
</div>



<div class="slide-no">53</div>


    </article>
  </slide>  <slide class="level-3" id="id42">
    <hgroup>
      <h3><code class="docutils literal"><span class="pre">query.get()</span></code></h3>
    </hgroup>
    <article class="">
      <p>A good example of this category of methods is <code class="docutils literal"><span class="pre">get</span></code>, which returns one
instance only.</p>
<div class="build container">
<p>It takes a primary key as an argument:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [16]: </span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gh">Out[16]: </span><span class="go">&lt;learning_journal.models.MyModel at 0x105f30208&gt;</span>
<span class="gp">In [17]: </span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">In [18]:</span>
</pre></div>
</div>
<p>If no item with that primary key is present, then the method returns
<code class="docutils literal"><span class="pre">None</span></code></p>
</div>



<div class="slide-no">54</div>


    </article>
  </slide>  <slide class="level-3" id="id43">
    <hgroup>
      <h3><code class="docutils literal"><span class="pre">query.all()</span></code></h3>
    </hgroup>
    <article class="">
      <p>Another example is one we've already seen.</p>
<div class="build container">
<p><code class="docutils literal"><span class="pre">query.all()</span></code> returns a list of all rows returned by the database:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [18]: </span><span class="n">q1</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="gh">Out[18]: </span><span class="go">[&lt;learning_journal.models.MyModel at 0x105f30208&gt;]</span>

<span class="gp">In [19]: </span><span class="nb">type</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="gh">Out[19]: </span><span class="go">list</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">query.count()</span></code> returns the number of rows that would have been returned
by the query:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [20]: </span><span class="n">q1</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="gh">Out[20]: </span><span class="go">1</span>
</pre></div>
</div>
</div>



<div class="slide-no">55</div>


    </article>
  </slide>  <slide class="level-3" id="id44">
    <hgroup>
      <h3>Creating New Objects</h3>
    </hgroup>
    <article class="">
      <p>Before getting into the other category, let's learn how to create new objects.</p>
<div class="build container">
<div class="container">
<p>We can create new instances of our <em>model</em> just like normal Python
objects:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [21]: </span><span class="n">new_model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fred&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gp">In [22]: </span><span class="n">new_model</span>
<span class="gh">Out[22]: </span><span class="go">&lt;learning_journal.models.MyModel at 0x105f4af28&gt;</span>
</pre></div>
</div>
</div>
<div class="container">
<p>In this state, the instance is <em>ephemeral</em>, our <code class="docutils literal"><span class="pre">session</span></code> knows
nothing about it:</p>
<div class="highlight-pycon"><div class="highlight"><pre><span class="go">In [23]: session.new</span>
<span class="go">Out[23]: IdentitySet([])</span>
</pre></div>
</div>
</div>
</div>



<div class="slide-no">56</div>


    </article>
  </slide>  <slide class="level-3" id="id45">
    <hgroup>
      <h3>Adding Objects to the Session</h3>
    </hgroup>
    <article class="">
      <p>For the database to know about our new object, we must <code class="docutils literal"><span class="pre">add</span></code> it to the
session:</p>
<div class="build container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [24]: </span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_model</span><span class="p">)</span>
<span class="gp">In [25]: </span><span class="n">session</span><span class="o">.</span><span class="n">new</span>
<span class="gh">Out[25]: </span><span class="go">IdentitySet([&lt;learning_journal.models.MyModel object at 0x105f4af28&gt;])</span>
</pre></div>
</div>
<p>We can even bulk-add new objects:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [26]: </span><span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
<span class="gp">In [27]: </span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;tom&#39;</span><span class="p">,</span> <span class="mi">13</span><span class="p">)]:</span>
<span class="gp">   ....: </span>    <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MyModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">))</span>
<span class="gp">   ....:</span>
<span class="gp">In [28]: </span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="gp">In [29]: </span><span class="n">session</span><span class="o">.</span><span class="n">new</span>
<span class="gh">Out[29]: </span><span class="go">IdentitySet([&lt;learning_journal.models.MyModel object at 0x105f4af28&gt;,</span>
<span class="go">                      &lt;learning_journal.models.MyModel object at 0x105f4a4a8&gt;,</span>
<span class="go">                      &lt;learning_journal.models.MyModel object at 0x105f30550&gt;])</span>
</pre></div>
</div>
</div>



<div class="slide-no">57</div>


    </article>
  </slide>  <slide class="level-3" id="id46">
    <hgroup>
      <h3>Committing Changes</h3>
    </hgroup>
    <article class="">
      <p>Up until now, the changes you've made are not permanent.</p>
<div class="build container">
<p>In order for these new objects to be saved to the database, the session
must be <code class="docutils literal"><span class="pre">committed</span></code>:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [30]: </span><span class="n">other_session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>
<span class="gp">In [31]: </span><span class="n">other_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="gh">Out[31]: </span><span class="go">1</span>
<span class="gp">In [32]: </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">In [33]: </span><span class="n">other_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="gh">Out[33]: </span><span class="go">4</span>
</pre></div>
</div>
<p>When you are using a <code class="docutils literal"><span class="pre">scoped_session</span></code> in Pyramid, this action is
automatically handled for you.</p>
<p>The session that is bound to a particular HTTP request is committed when a
response is sent back.</p>
<p>(don't worry if this seems confusing, more to come next week)</p>
</div>



<div class="slide-no">58</div>


    </article>
  </slide>  <slide class="level-3" id="id47">
    <hgroup>
      <h3>Altering Objects</h3>
    </hgroup>
    <article class="">
      <p>You can edit objects that are already part of a session, or that are fetched by
a query.</p>
<div class="build container">
<p>Simply change the values of a persisted attribute, the session will know
it's been updated:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [34]: </span><span class="n">new_model</span>
<span class="gh">Out[34]: </span><span class="go">&lt;learning_journal.models.MyModel at 0x105f4af28&gt;</span>
<span class="gp">In [35]: </span><span class="n">new_model</span><span class="o">.</span><span class="n">name</span>
<span class="gh">Out[35]: </span><span class="go">&#39;fred&#39;</span>
<span class="gp">In [36]: </span><span class="n">new_model</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;larry&#39;</span>
<span class="gp">In [37]: </span><span class="n">session</span><span class="o">.</span><span class="n">dirty</span>
<span class="gh">Out[37]: </span><span class="go">IdentitySet([&lt;learning_journal.models.MyModel object at 0x105f4af28&gt;])</span>
</pre></div>
</div>
<p>Commit the session to persist the changes:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [38]: </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">In [39]: </span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">other_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)]</span>
<span class="gh">Out[39]: </span><span class="go">[&#39;one&#39;, &#39;larry&#39;, &#39;bob&#39;, &#39;tom&#39;]</span>
</pre></div>
</div>
</div>



<div class="slide-no">59</div>


    </article>
  </slide>  <slide class="level-3" id="id48">
    <hgroup>
      <h3>Methods Returning Queries</h3>
    </hgroup>
    <article class="">
      <p>Returning to query methods, a good example of the second type is the <code class="docutils literal"><span class="pre">filter</span></code>
method.</p>
<div class="build container">
<p>This method allows you to reduce the number of results, based on criteria:</p>
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [40]: </span><span class="p">[(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)]</span>
<span class="gh">Out[40]: </span><span class="go">[(&#39;one&#39;, 1), (&#39;larry&#39;, 3), (&#39;tom&#39;, 13)]</span>
</pre></div>
</div>
</div>



<div class="slide-no">60</div>


    </article>
  </slide>  <slide class="level-3" id="id49">
    <hgroup>
      <h3><code class="docutils literal"><span class="pre">order_by</span></code></h3>
    </hgroup>
    <article class="">
      <p>Another typical method in this category is <code class="docutils literal"><span class="pre">order_by</span></code>:</p>
<div class="build container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [41]: </span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">value</span><span class="p">)]</span>
<span class="gh">Out[41]: </span><span class="go">[1, 3, 13, 34]</span>

<span class="gp">In [42]: </span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>
<span class="gh">Out[42]: </span><span class="go">[&#39;bob&#39;, &#39;larry&#39;, &#39;one&#39;, &#39;tom&#39;]</span>
</pre></div>
</div>
</div>



<div class="slide-no">61</div>


    </article>
  </slide>  <slide class="level-3" id="id50">
    <hgroup>
      <h3>Method Chaining</h3>
    </hgroup>
    <article class="">
      <p>Since methods in this category return <code class="docutils literal"><span class="pre">Query</span></code> objects, they can be safely
<em>chained</em> to build more complex queries:</p>
<div class="build container">
<div class="highlight-ipython"><div class="highlight"><pre><span class="gp">In [43]: </span><span class="n">q1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span>
<span class="gp">In [44]: </span><span class="n">q1</span> <span class="o">=</span> <span class="n">q1</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">MyModel</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="gp">In [45]: </span><span class="p">[(</span><span class="n">o</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">q1</span><span class="p">]</span>
<span class="gh">Out[45]: </span><span class="go">[(&#39;larry&#39;, 3), (&#39;one&#39;, 1), (&#39;tom&#39;, 13)]</span>
</pre></div>
</div>
<p>Note that you can do this inline as well
(<code class="docutils literal"><span class="pre">s.query(Model).filter().order_by()</span></code>)</p>
<p>Also note that when using chained queries like this, no query is actually
sent to the database until you require a result.</p>
</div>



<div class="slide-no">62</div>


    </article>
  </slide>  <slide class="level-3" id="cleaning-up-after-ourselves">
    <hgroup>
      <h3>Cleaning Up After Ourselves</h3>
    </hgroup>
    <article class="">
      <p>When you are experimenting with a new system, you often create data that is
messy or incomplete.</p>
<div class="build container">
<p>It's good to remember that none of the information we've persisted to our
database is vital to us.</p>
<p>For homework this week we'll be making new models, and the data we have in
our current database will only get in the way.</p>
<p>Until you have real production data it is always safe simply to delete the
database and start over:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">$ </span>rm learning_journal.sqlite
</pre></div>
</div>
<p>You can always re-create it by executing <code class="docutils literal"><span class="pre">initialize_learning_journal_db</span></code></p>
</div>



<div class="slide-no">63</div>


    </article>
  </slide>  <slide class="level-2" id="homework">
    <hgroup>
      <h2>Homework</h2>
    </hgroup>
    <article class="">
      <p class="left">Okay, that's enough for the moment.</p>
<div class="build left container">
<p>You've learned quite a bit about how <em>models</em> work in SQLAlchemy</p>
<p>It's time to put that knowledge to good use.</p>
<p>For the first part of your assignment this week you will begin to define
the data model for our learning journal application.</p>
<p>I'll provide a specification, you define the model required to do the job.</p>
<p>I'll also ask you to define a few methods to complete the first part of our
API.</p>
</div>



<div class="slide-no">64</div>


    </article>
  </slide>  <slide class="level-3" id="the-model">
    <hgroup>
      <h3>The Model</h3>
    </hgroup>
    <article class="">
      <p>Our model will be called an <code class="docutils literal"><span class="pre">Entry</span></code>. Here's what you need to know:</p>
<ul class="simple">
<li>It should be stored in a database table called <code class="docutils literal"><span class="pre">entries</span></code></li>
<li>It should have a primary key field called <code class="docutils literal"><span class="pre">id</span></code></li>
<li>It should have a <code class="docutils literal"><span class="pre">title</span></code> field which accepts unicode text up to 255 characters in length</li>
<li>The <code class="docutils literal"><span class="pre">title</span></code> should be unique and it should be impossible to save an
<code class="docutils literal"><span class="pre">entry</span></code> without a <code class="docutils literal"><span class="pre">title</span></code>.</li>
<li>It should have a <code class="docutils literal"><span class="pre">body</span></code> field which accepts unicode text of any length
(including none)</li>
<li>It should have a <code class="docutils literal"><span class="pre">created</span></code> field which stores the date and time the object
was created.</li>
<li>It should have an <code class="docutils literal"><span class="pre">edited</span></code> field which stores the date and time the object
was last edited.</li>
</ul>



<div class="slide-no">65</div>


    </article>
  </slide>  <slide class="level-3" id="id51">
    <hgroup>
      <h3>The Model</h3>
    </hgroup>
    <article class="">
      <ul class="simple">
<li>Both the <code class="docutils literal"><span class="pre">created</span></code> and <code class="docutils literal"><span class="pre">edited</span></code> field should default to <code class="docutils literal"><span class="pre">now</span></code> if not
provided when a new instance is constructed.</li>
<li>The <code class="docutils literal"><span class="pre">entry</span></code> class should support a classmethod <code class="docutils literal"><span class="pre">all</span></code> that returns all the
entries in the database, ordered so that the most recent entry is first.</li>
<li>The <code class="docutils literal"><span class="pre">entry</span></code> class should support a classmethod <code class="docutils literal"><span class="pre">by_id</span></code> that returns a
single entry, given an <code class="docutils literal"><span class="pre">id</span></code>.</li>
</ul>
<p>Remember that in order to have your new model table created, you will have to
re-run the <code class="docutils literal"><span class="pre">initialize_learning_journal_db</span></code> script after creating your model.</p>



<div class="slide-no">66</div>


    </article>
  </slide>  <slide class="level-3" id="id52">
    <hgroup>
      <h3>Words of Advice</h3>
    </hgroup>
    <article class="">
      <p>Use the documentation linked in this presentation to assist you.  SQLAlchemy
has fantastic documentation, but it can be a bit overwhelming.  Everything you
require for this assignment is on one or more of the pages linked above.</p>
<p>As you define this new model for our application, make frequent commits to your
github repository. Remember to write meaningful commit messages.</p>
<p>Don't be afraid to start up a Python interpreter and play with your model. Try
things out. Learn how this all works by making mistakes. Remember the
<code class="docutils literal"><span class="pre">pshell</span></code> command and how we set up a session once the shell is running.</p>
<p>Errors at the SQL level can sometimes leave your session unusable. To restore
it, use the <code class="docutils literal"><span class="pre">session.rollback()</span></code> method.  You'll lose uncommitted changes,
but you'll gain a session that can be used again.</p>



<div class="slide-no">67</div>


    </article>
  </slide>  <slide class="level-3" id="id53">
    <hgroup>
      <h3>Submitting Your Work</h3>
    </hgroup>
    <article class="">
      <p>I want to be able to review your code (and you want to be able to share it).</p>
<p>To submit this assignment, you'll need to add this learning_journal repository
to GitHub.</p>
<p>On the GitHub website you can create a new repository.  Set it up to be
completely empty. Name it <code class="docutils literal"><span class="pre">learning_journal</span></code> and give it any description you
like.</p>
<p>When you've created an empty repository in GitHub, you should see a set of
directions for connecting it to a repository that you've already built. Follow
those instructions to connect your emtpy GitHub repository as the <code class="docutils literal"><span class="pre">origin</span></code>
remote to your <code class="docutils literal"><span class="pre">learning_journal</span></code> repository on your machine.</p>
<p>Finally, push your <code class="docutils literal"><span class="pre">master</span></code> branch to your new <code class="docutils literal"><span class="pre">origin</span></code> remote on GitHub.</p>
<p>When you are done, send me an email with the URL for your new repository.</p>



<div class="slide-no">68</div>


    </article>
  </slide>  <slide class="level-3" id="id54">
    <hgroup>
      <h3>The Model</h3>
    </hgroup>
    <article class="">
      <p><strong>Our work next week will assume that you have completed this assignment</strong></p>
<p>Do not delay working on this until the last moment.</p>
<p>Do not skip this assignment.</p>
<p>Do ask questions frequently via email (use the <a class="reference external" href="https://groups.google.com/forum/#!forum/programming-in-python">class google group</a>).</p>
<p>See you next week!</p>



<div class="slide-no">69</div>


    </article>
  </slide>


    <slide class="thank-you-slide segue nobackground">
    <aside class="gdbar right"><img src="../_static/logo_UW.png"></aside>
    <article class="flexbox vleft auto-fadein">
      <h2>Good Night!</h2>
      <p>&nbsp;</p>
    </article>
    <p class="auto-fadein" data-config-contact>
      <!-- populated from slide_config.json -->
    </p>
  </slide>

  <slide class="backdrop"></slide>

</slides>

<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>